You just produced a detailed forensic audit of the CRStats app.

Now I want you to move into **FULL FIX mode**:  
I do NOT want to leave ‚ÄúP1s‚Äù for later. I want to address:

- All üü° (implemented but incomplete/fragile),
- All üß© (mock/placeholder),
- All üî¥ (planned but not implemented)

from your audit, in a **single, coherent v1 pass**.

‚ö†Ô∏è Important:

- Do NOT redesign the app.
- Do NOT break existing working flows (sync, coach, training, billing).
- Keep the current UX and architecture; just **finish and de-mock** everything.

Use your own audit as the baseline of what‚Äôs missing.

---

## 1. Replace all MOCK data with real data

### 1.1 Dashboard trophy chart

From your audit:
- `client/src/pages/dashboard.tsx` uses hardcoded `chartData` for trophy progress.

What to do:

- Replace `chartData` with real series derived from battles or pushes.
- Use the same data source and logic as in `/me`:
  - You already compute trophy evolution based on battles.
- Implement a small helper (domain-level or hook):
  - Input: recent battles from the unified `/api/player/sync` response.
  - Output: array of `{ time, trophies }` suitable for the chart.
- Make sure the chart behaves sensibly when:
  - There are few battles,
  - No battles yet (show an empty state).

Acceptance:
- No hardcoded trophy chart data remains.
- Chart represents real evolution for a real player.

### 1.2 Decks page (My Decks & Meta Decks) ‚Äì no more mockCards

From your audit:
- `client/src/pages/decks.tsx` imports `mockCards` and uses static data.

What to do:

- ‚ÄúMy Decks‚Äù tab:
  - Compute the user‚Äôs most-played decks from real battles:
    - Use the same deck detection logic already used in `/me` (deckUsage and archetypeAnalysis).
    - Aggregate battles by deck composition to identify:
      - Main deck(s),
      - Win rate,
      - Number of games.
  - Show real card icons and stats, not mockCards.

- ‚ÄúMeta Decks‚Äù tab:
  - Implement a minimal meta deck feature:
    - Option A (preferred): use a `meta_decks` or `meta_decks_cache` table fed by a simple backend aggregation:
      - Aggregate frequent decks from high-trophy players (e.g., top ladder or a range).
    - Option B (simpler fallback): call Clash Royale ranking endpoints for a specific location/league (e.g., top global) and derive meta decks from their recent battles.
  - Store meta decks server-side and expose via an API (e.g., `/api/meta/decks`).
  - Decks page consumes that API.

Acceptance:
- Decks page no longer imports `mockCards`.
- ‚ÄúMy Decks‚Äù shows real decks with correct win rates.
- ‚ÄúMeta Decks‚Äù shows decks derived from real data (even if simple), not placeholders.

### 1.3 Community & Rankings with real data

From your audit:
- `community.tsx` uses `mockRankings` and static clan placeholders.

What to do:

- Implement backend routes to fetch rankings from the official Clash Royale API:
  - `/api/community/player-rankings` ‚Üí wrappers for `/locations/{locationId}/rankings/players` or similar.
  - `/api/community/clan-rankings` ‚Üí wrappers for clan rankings.
- Replace `mockRankings` in `community.tsx` with calls to these APIs.
- For the ‚ÄúTop Clans‚Äù tab:
  - Use real clan rankings from the API, not ‚ÄúEm breve‚Äù.

Acceptance:
- Community page uses real player and clan rankings.
- No imports from `mockData.ts` remain.

### 1.4 Public Profile and Clan pages

From your audit:
- `/p/:tag` (public-profile.tsx) uses `mockPlayer`.
- `/clan/:tag` does not exist yet.

What to do:

- Public player profile `/p/:tag`:
  - Implement API route `/api/public/player/:tag` if it doesn‚Äôt exist yet, using real Clash API.
  - Page should:
    - Fetch real player data (name, tag, arena, trophies, clan).
    - Show recent battles summary if available.
  - Remove all usage of `mockPlayer`.

- Clan page `/clan/:tag` (new):
  - Implement API route `/api/public/clan/:tag` using Clash API.
  - Create a page `client/src/pages/clan/[tag].tsx` or equivalent:
    - Show clan name, score, war trophies, member list, top players.
  - Integrate linking:
    - From player profile, clicking clan name goes to `/clan/:tag`.
    - From Community tab, clicking a clan goes to `/clan/:tag`.

Acceptance:
- `/p/:tag` and `/clan/:tag` show real data for real tags.
- No `mockPlayer` uses remain.

---

## 2. Complete and harden partially implemented features (üü°)

### 2.1 Settings Preferences must persist (and reflect reality)

From your audit:
- Preferences tab UI (theme, notifications, etc.) renders but does not save.

What to do:

- Confirm the canonical settings API (`/api/settings`) and `user_settings` table.
- In `settings.tsx`:
  - On page load:
    - Fetch user settings and bind them to the Switch/Select components.
  - On change:
    - Update local state.
    - Call the API to persist changes.
- Ensure:
  - Theme setting integrates with existing theme provider.
  - Notification preferences are stored, even if not fully used yet.
- Do not add new settings types beyond what the UI already shows.

Acceptance:
- Toggling a switch, refreshing the page keeps the state.
- No hardcoded defaults overriding server values.

### 2.2 Billing tab ‚Äì show REAL subscription status and invoices

From your audit:
- Billing tab hardcodes "FREE".
- Webhooks update `subscriptions`, but settings UI doesn‚Äôt read it.
- Payment history text exists but is not wired.

What to do:

- Use existing `/api/billing/subscription` or similar:
  - Show:
    - Plan: FREE or PRO (based on status).
    - PRO details: current period end, trial vs active.
- Add a simple ‚ÄúPayment History‚Äù section:
  - Call Stripe‚Äôs API from the backend (not from client) to list last N invoices for the Stripe customer linked to the user.
  - Show:
    - Date, amount, status (paid/failed).
- Wire:
  - ‚ÄúManage subscription‚Äù to the existing customer portal endpoint.
  - ‚ÄúUpgrade to PRO‚Äù to the checkout endpoint.

Acceptance:
- Switching a user from FREE ‚Üí PRO via your test checkout reflects immediately on Billing page.
- Invoices section shows real Stripe test invoices for PRO users.

### 2.3 Stripe webhook security and coverage

From your audit:
- `/api/stripe/webhook` handles events but lacks signature verification and some event types.

What to do:

- Add Stripe signature verification using a `STRIPE_WEBHOOK_SECRET` env:
  - Use `stripe.webhooks.constructEvent` (or equivalent).
  - Reject invalid signatures with 400 and log.
- Add at least `invoice.payment_failed` handling:
  - Mark subscription as past_due or cancelled, as you prefer.
  - Optionally create an in-app notification about payment issues (see notifications section below).

Acceptance:
- Webhook properly checks Stripe signatures.
- `invoice.payment_failed` is handled gracefully and updates subscription status.

### 2.4 AI coach context must include tilt + goals

From your audit:
- Coach context currently includes player, deck, recent battles.
- Tilt level and goals are NOT injected into the prompt.

What to do:

- Use your existing tilt computation and goals APIs:
  - On coach chat backend:
    - Load:
      - Current tilt summary: level (HIGH/MEDIUM/NONE), wins/losses, net trophies.
      - Active user goals (top 3).
- Extend the system/context for the LLM:
  - Add a short, structured summary:
    - ‚ÄúTilt status: HIGH (lost 4 of last 5, ‚àí120 trophies in 45 minutes).‚Äù
    - ‚ÄúActive goals: reach 8000 trophies; improve X-Bow matchup; avoid tilt after 2 losses.‚Äù
  - Update the system prompt to instruct:
    - When tilt is HIGH, prioritize mental/game hygiene advice.
    - Tie suggestions back to the goals when appropriate.

Acceptance:
- In high tilt situations, coach explicitly mentions tilt.
- When goals exist, coach references them in answers.

### 2.5 Goals auto-progress (at least for trophy goals)

From your audit:
- Goals CRUD is real but progresses only manually.

What to do (minimal useful version):

- Identify goals that track trophies (e.g., type ‚Äútrophies‚Äù, or via a metadata field).
- During `/api/player/sync`:
  - If the current trophies surpass a goal‚Äôs target, mark that goal as completed with `completedAt`.
  - If between min and target, update `currentValue`.
- Ensure UI reflects these updates without requiring manual edits.

Acceptance:
- Creating a trophy-based goal and then gaining trophies updates the goal automatically on sync.

### 2.6 Notifications ‚Äì hook basic triggers

From your audit:
- Notifications tables+routes exist but no code populates them.

What to do (minimal version):

- Define 3‚Äì4 key notification triggers, e.g.:
  1. New training plan generated from a push analysis.
  2. A training plan is completed (all drills finished).
  3. Subscription status change (FREE‚ÜíPRO, PRO‚ÜíFREE).
  4. High tilt detected on sync (optional).

- For each, when the event happens:
  - Create a notification record with:
    - Type, title, short message, createdAt, read=false.
- Ensure:
  - The existing notifications UI (bell, sheet, page) shows them.
  - Notification preferences are obeyed if already modeled in DB.

Acceptance:
- When I generate a training plan, I see a new in-app notification.
- When PRO is activated, I see a notification about subscription upgrade.

### 2.7 Onboarding flow must run for new users

From your audit:
- `onboarding.tsx` exists but is not wired into routing.
- Users can land in dashboard without linking a Clash tag.

What to do:

- Implement a simple onboarding enforcement:
  - If user is authenticated but has no `clashTag` linked:
    - Redirect them to the onboarding page on first access.
  - Once they complete Clash tag linking successfully:
    - Mark onboarding as completed and redirect to dashboard.

Acceptance:
- New user logging in for the first time is guided through tag linking before using core features.

---

## 3. Finish planned but missing features (üî¥) to a minimal real version

### 3.1 Meta decks cache (server-side)

From your audit:
- Mention of meta decks cache, but no actual implementation.

What to do (minimal but real):

- Add a `meta_decks_cache` table if not already:
  - Fields: id, name, cards[], winRateEstimate, sampleSize, lastUpdatedAt.
- Create a backend job/route to refresh meta decks:
  - Simple approach: when `/api/meta/decks` is called:
    - If cache is older than X hours:
      - Fetch high-level data from Clash API (e.g., top players‚Äô decks).
      - Aggregate by deck composition and store top N in cache.
- Decks page uses this API instead of mock meta.

Acceptance:
- Meta decks endpoint returns a consistent set of decks based on real data.
- Cache avoids hitting Clash API too often.

### 3.2 Clan pages and integration with Community

Already partly covered in 1.4. Make sure:

- Community clan rankings link to `/clan/:tag`.
- Clan page loads real clan info and member list.

### 3.3 Payment history in Billing

Covered above in 2.2; ensure it is implemented to a minimal useful level.

---

## 4. i18n ‚Äì remove remaining hardcoded PT-BR strings

From your audit:
- Hardcoded PT-BR exist in community.tsx, decks.tsx, settings.tsx, profile.tsx, public-profile.tsx, etc.

What to do:

- For each of these pages/components:
  - Replace hardcoded strings with calls to the i18n system (`t()`).
  - Add corresponding keys to `pt-BR.json` and `en-US.json`.
- Ensure:
  - No console warnings about missing keys.
  - Both PT-BR and EN-US feel consistent, at least at label level.

---

## 5. Clean up legacy / unused code

From your audit:
- `profile.tsx` is a legacy page using `mockPlayer`.

What to do:

- Either:
  - Remove the legacy `profile.tsx` page, OR
  - Update it to be a thin wrapper around the new settings/profile logic.
- Remove or refactor any other obvious dead code that only uses mocks and is not part of the new UX.

---

## 6. Constraints & Quality Bar

- No regressions in:
  - Auth,
  - Sync,
  - Coach chat,
  - Push analysis,
  - Training Center,
  - Stripe checkout.

- TypeScript strict must still pass.
- Run whatever lint/build commands exist and ensure all compile.
- Avoid introducing new mocks; everything should be real or clearly disabled.

---

## 7. At the end, report back

When you‚Äôre done, please give me:

1. A list of key files you changed for each major item:
   - Mock removal (Dashboard, Decks, Community, Public/Clan profiles).
   - Settings & Billing.
   - Stripe webhook.
   - Coach prompt context.
   - Goals auto-progress & Notifications.
   - Onboarding.
   - i18n cleanup.

2. A short manual test checklist, e.g.:

- ‚ÄúTo test Dashboard chart: do X‚Ä¶‚Äù
- ‚ÄúTo test Decks My Decks/Meta: do Y‚Ä¶‚Äù
- ‚ÄúTo test Coach tilt/goals context: do Z‚Ä¶‚Äù
- etc.

Focus on actually implementing and wiring up everything described above.
