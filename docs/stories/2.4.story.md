# Story 2.4: Advanced Battle Stats & Analytics

## Status: InProgress
## Priority: P1
## Effort: M (2-3 days)
## Phase: 2

## Description

The current tracker shows basic player stats and battle history, but lacks the deeper analytics that competitive players crave. This story fills the remaining 30% gap in the Stats/Tracker dimension by adding: 3-crown rate per deck, card-level win rates, matchup matrix (card vs card), and season-over-season tracking.

These features transform the "Me" page from a simple stats viewer into a comprehensive analytics dashboard that rivals StatsRoyale and goes beyond it with per-arena granularity.

## Acceptance Criteria

### 3-Crown Rate
- [x] AC1: Each deck displayed in the meta decks page (Story 2.1) includes a 3-crown rate percentage — the proportion of wins that are 3-crown victories.
- [x] AC2: Player's personal deck history shows 3-crown rate for each deck they've used.

### Card Win Rates
- [x] AC3: A new section/page shows win rate per card across the player's battle history. Cards are ranked by win rate with at least 10 battles sample.
- [ ] AC4: Global card win rates per arena are available from the meta pipeline data (top/bottom performing cards per arena). *(Depends on meta pipeline enhancement — deferred to pipeline story)*

### Matchup Data
- [x] AC5: When viewing a specific deck (in meta or personal), the system shows its performance against the 5 most common opposing deck archetypes (e.g., "vs Golem Beatdown: 62% WR, 45 battles").
- [x] AC6: Matchup data is calculated from battle history (pipeline data + player's own battles).

### Season Tracking
- [x] AC7: Player stats are segmented by season. The "Me" page shows a season selector to view stats from previous seasons.
- [x] AC8: A season summary card shows: peak trophies, total battles, win rate, most used deck, best performing card.

### Data Processing
- [x] AC9: Battle history processing extracts and stores: deck composition, crown count (1/2/3), opponent deck, arena, season, result. This enriches the data from player sync.
- [x] AC10: Stats calculations are performed server-side and cached. Personal stats update on each sync. Global stats update with the daily pipeline.

## Scope

### IN
- 3-crown rate calculation and display (personal + global)
- Card-level win rate tracking
- Basic matchup data (deck vs archetype)
- Season segmentation for player stats
- Server-side stats processing and caching
- UI enhancements to the Me page and decks page

### OUT
- Full matchup matrix (all cards × all cards) — too data-intensive for MVP
- Predictive analytics (ML-based win probability)
- Opponent scouting (looking up opponent's history mid-match)
- Replay analysis
- Advanced statistical models (Bayesian win rate, confidence intervals)

## Dependencies

- Depends on: Story 2.2 (production for data pipeline)
- Blocks: Story 2.7 (community features use stats data)

## Technical Notes

### Key Files Affected
- `server/domain/battleHistory.ts` — enhance with stats extraction
- `server/domain/statsEngine.ts` — new: stats calculation engine
- `server/routes/player.ts` — new endpoints for detailed stats
- `client/src/pages/me/` — enhance stats sections (post-decomposition from Epic 1)
- `client/src/pages/decks.tsx` — add 3-crown rate, matchup info to deck cards
- `shared/schema.ts` — new types for enriched stats

### Data Model Enhancement
```sql
-- Battle stats aggregate (cached, recalculated on sync)
CREATE TABLE battle_stats_cache (
  user_id TEXT NOT NULL,
  season INTEGER,
  deck_hash TEXT,  -- hash of sorted card IDs
  battles INTEGER DEFAULT 0,
  wins INTEGER DEFAULT 0,
  three_crowns INTEGER DEFAULT 0,
  avg_elixir REAL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Card performance per player
CREATE TABLE card_performance (
  user_id TEXT NOT NULL,
  card_id TEXT NOT NULL,
  season INTEGER,
  battles INTEGER DEFAULT 0,
  wins INTEGER DEFAULT 0,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Risks
- **Battle history depth:** Clash Royale API only returns last 25 battles. Mitigation: accumulate over time with each sync, store permanently
- **Sample size for personal stats:** New users won't have enough data. Mitigation: show "N battles" count, require minimum 10 battles before showing rates
- **Performance on stats page:** Complex aggregations could be slow. Mitigation: pre-calculate and cache, update on sync

## Definition of Done

- [x] 3-crown rate visible on meta decks and personal deck history
- [x] Card win rates page shows player's card performance
- [x] Matchup data shows top 5 opposing archetypes per deck
- [x] Season selector works on Me page
- [x] Season summary card displays correctly
- [x] Stats update on each player sync
- [x] All existing tests pass (102/102)
- [x] New stats endpoints have integration tests (32 new tests)
- [x] Lint passes (no lint script in project; no ESLint errors)
- [x] Type check passes (no new TS errors in Story 2.4 files)

---

## File List

### New Files
| File | Purpose |
|------|---------|
| `server/domain/statsEngine.ts` | Stats calculation engine: season derivation, battle processing, card/deck/matchup stats |
| `client/src/pages/me/MeAdvancedStatsSection.tsx` | Advanced stats UI: season selector, summary card, deck stats, card win rates, matchups |
| `tests/integration/routes/statsEngine.test.ts` | 19 unit tests for statsEngine.ts |
| `tests/integration/routes/playerStats.test.ts` | 13 integration tests for stats API endpoints |

### Modified Files
| File | Changes |
|------|---------|
| `shared/schema.ts` | Added `battleStatsCache` and `cardPerformance` tables, indexes, insert schemas, types, relations, Zod query schemas |
| `server/storage.ts` | Added 6 IStorage methods: `upsert/get/clearBattleStatsCache`, `upsert/get/clearCardPerformance` |
| `server/routes/player.ts` | Added 4 API endpoints (`/stats/cards`, `/stats/decks`, `/stats/season`, `/stats/matchups`), stats processing in sync route |
| `client/src/lib/api.ts` | Added stats types and `api.player.stats.*` client methods |
| `client/src/pages/me/MeCardsTab.tsx` | Integrated `MeAdvancedStatsSection` component |
| `client/src/pages/decks/MetaDecksTab.tsx` | Added 3-crown rate display to `ArenaMetaDeckCard` |
| `shared/i18n/translations/en-US.json` | Added `pages.me.advancedStats.*` i18n keys |
| `shared/i18n/translations/pt-BR.json` | Added `pages.me.advancedStats.*` pt-BR translations |
| `tests/integration/helpers/app.ts` | Added `mountPlayerStatsRoutes` test helper |
| `tests/integration/helpers/mocks.ts` | Added 6 mock IStorage methods for stats tables |

---

## Change Log

- 2026-02-27: @pm created from Epic 2. Closes the 30% tracker gap. Status: Draft.
- 2026-02-27: @dev implemented Story 2.4. 9/10 ACs complete (AC4 deferred to pipeline story). 4 new files, 10 modified files. 32 new tests, 102 total pass. Status: Draft -> InProgress.
