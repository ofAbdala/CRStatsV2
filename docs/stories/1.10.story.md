# Story 1.10: Frontend Hardening -- Settings Decomposition, Code Split, Error Recovery & Security

## Status: Done
## Priority: P2
## Effort: L (5-8 days)
## Phase: 4

## Description

This story addresses remaining frontend quality issues: decomposing the oversized settings page, implementing route-based code splitting to reduce initial bundle size, adding consistent error recovery across all pages, eliminating `as any` type casting to restore TypeScript safety, and adding security protections for user-submitted text.

The `<PrivateRoute>` wrapper from Story 1.4 enables both code splitting (React.lazy + Suspense) and consistent ErrorBoundary wrapping as built-in behaviors of the routing system.

## Technical Debt Items

- **TD-023:** `settings.tsx` oversized at 763 lines -- 3 tabs in one file (MEDIUM)
- **TD-024:** No route-based code splitting -- all 18 pages loaded eagerly (MEDIUM)
- **TD-029:** Excessive `as any` type casting -- 27 instances in frontend across 9 files (MEDIUM)
- **TD-055:** ErrorBoundary inconsistency -- decks, community, settings, onboarding lack ErrorBoundary (MEDIUM)
- **TD-059:** No XSS protection on text fields -- coach messages, goal descriptions, display names (MEDIUM)
- **TD-060:** Stripe webhook signature verification unclear -- verify and document (MEDIUM)

## Acceptance Criteria

### Settings Decomposition (TD-023)
- [x] AC1: `settings.tsx` is decomposed into:
  - `AccountTab.tsx` -- account settings
  - `BillingTab.tsx` -- billing/subscription management
  - `PreferencesTab.tsx` -- language, notification preferences
- [x] AC2: `settings.tsx` itself is a thin shell (< 200 lines) that manages tab state.
- [x] AC3: No individual settings file exceeds 400 lines.

### Code Splitting (TD-024)
- [x] AC4: All page imports in `App.tsx` use `React.lazy()` with `Suspense` fallback.
- [x] AC5: The initial bundle no longer includes code for pages the user has not navigated to. Specifically, the Recharts library (~400KB unminified) is only loaded when the user visits a chart-heavy page (me, decks). Verified: `AreaChart-DQBu0wrN.js` (385KB) is a separate chunk.
- [x] AC6: A loading spinner or skeleton is shown while lazy-loaded pages are being fetched. `PageLoadingFallback` component with Loader2 spinner.
- [x] AC7: Navigation between pages works smoothly -- no flash of empty content.

### Error Recovery (TD-055)
- [x] AC8: All routes in `App.tsx` are wrapped with `ErrorBoundary`. No route renders without error protection.
- [x] AC9: The ErrorBoundary shows a user-friendly error message with a "Try Again" button (not a white screen).
- [x] AC10: Particularly critical: onboarding, decks, community, and settings routes (previously unprotected) now have ErrorBoundary.

### Type Safety (TD-029)
- [x] AC11: The number of `as any` casts in frontend code is reduced by at least 80% (from 27 to < 6). Result: 27 -> 0 (100% reduction).
- [x] AC12: Proper TypeScript interfaces exist for: API response payloads, battle data structures, and deck data structures. Added ~150 lines of interfaces in `api.ts`.
- [x] AC13: `fetchAPI<any>` calls in `client/src/lib/api.ts` are replaced with typed generic calls (`fetchAPI<PlayerData>`, etc.).

### Security (TD-059 + TD-060)
- [x] AC14: User-submitted text fields (coach messages, goal descriptions, display names) are sanitized on the server before storage. Custom `sanitizeBodyMiddleware` strips HTML tags, decodes entities, collapses whitespace.
- [x] AC15: Rendered user-generated content is escaped or sanitized on the client side to prevent XSS. No `dangerouslySetInnerHTML` on user content (only in shadcn chart CSS, safe). React auto-escapes by default.
- [x] AC16: Stripe webhook signature verification is confirmed present (`stripe.webhooks.constructEvent(body, sig, webhookSecret)`) at `server/routes/billing.ts:446`. Already implemented correctly.

## Scope

### IN
- Decomposing `settings.tsx` into 3 tab components
- Implementing `React.lazy()` + `Suspense` for all page imports
- Adding `ErrorBoundary` to all routes (leveraging `PrivateRoute` from Story 1.4)
- Replacing `as any` casts with proper TypeScript interfaces
- Adding input sanitization for text fields
- Verifying/implementing Stripe webhook signature verification

### OUT
- Settings page redesign or feature changes
- SSR or server-side code splitting
- Comprehensive type refactoring of server-side `any` types (backend `as any` in routes.ts/storage.ts)
- New security features beyond XSS protection

## Dependencies

- Depends on: Story 1.4 (PrivateRoute wrapper enables code splitting and ErrorBoundary integration)
- Blocks: None

## Technical Notes

### Key Files Affected
- `client/src/pages/settings.tsx` -- decomposed
- `client/src/pages/settings/AccountTab.tsx` -- new
- `client/src/pages/settings/BillingTab.tsx` -- new
- `client/src/pages/settings/PreferencesTab.tsx` -- new
- `client/src/App.tsx` -- React.lazy imports, ErrorBoundary wrapping
- `client/src/components/auth/PrivateRoute.tsx` -- potentially add ErrorBoundary as default
- `client/src/lib/api.ts` -- typed API calls
- `client/src/types/` -- new: TypeScript interface definitions
- `server/routes/billing.ts` -- Stripe webhook verification check
- `server/middleware/sanitize.ts` -- new: input sanitization middleware
- Multiple `.tsx` files -- `as any` removal

### Approach

**Code splitting pattern:**
```tsx
const MePage = React.lazy(() => import('./pages/me'));
const DecksPage = React.lazy(() => import('./pages/decks'));

// In routes:
<Suspense fallback={<PageSkeleton />}>
  <MePage />
</Suspense>
```

**ErrorBoundary integration with PrivateRoute:**
```tsx
function PrivateRoute({ children }) {
  const { isAuthenticated } = useAuth();
  if (!isAuthenticated) return <Navigate to="/auth" />;
  return <ErrorBoundary fallback={<ErrorFallback />}>{children}</ErrorBoundary>;
}
```

**Sanitization:**
```typescript
import createDOMPurify from 'dompurify';
const DOMPurify = createDOMPurify(window);

// Server-side: use sanitize-html or similar
function sanitizeInput(text: string): string {
  return text.replace(/<[^>]*>/g, '').trim();
}
```

### Risks
- **Code splitting and React Query:** Ensure that React Query cache is not affected by lazy loading. Data should persist across page navigations.
- **`as any` removal:** Some `as any` casts may exist because the underlying types are genuinely complex (e.g., Recharts prop types). In those cases, use more specific type assertions (`as ChartData`) rather than trying to fix the upstream type.
- **Stripe webhook verification (TD-060):** If verification is currently MISSING, this becomes a CRITICAL security fix that should be implemented immediately. The assessment marks it as "unclear" -- verify first, then implement if needed.

## Definition of Done

- [x] All 6 TD items addressed
- [x] settings.tsx decomposed, no file > 400 lines
- [x] All pages lazy-loaded with Suspense fallback
- [x] All routes have ErrorBoundary protection
- [x] `as any` count reduced by >= 80% (100% -- 27 to 0)
- [x] User input is sanitized before storage
- [x] Stripe webhook signature verification confirmed/implemented
- [x] All existing tests pass (19/19)
- [x] Lint passes (N/A -- no lint script configured in project)
- [x] Type check passes (only pre-existing next/link error remains)
- [x] No new CRITICAL issues introduced
- [x] Code reviewed

---

## File List

### New Files
- `client/src/pages/settings/index.tsx` -- thin shell managing tab state (~50 lines)
- `client/src/pages/settings/AccountTab.tsx` -- account settings tab (~224 lines)
- `client/src/pages/settings/SavedProfilesCard.tsx` -- saved player profiles management (~278 lines)
- `client/src/pages/settings/BillingTab.tsx` -- billing/subscription tab (~146 lines)
- `client/src/pages/settings/PreferencesTab.tsx` -- language/notification preferences tab (~147 lines)
- `client/src/pages/settings/types.ts` -- shared types for settings components (~62 lines)
- `server/middleware/sanitize.ts` -- XSS sanitization middleware (sanitizeText, sanitizeFields, sanitizeBodyMiddleware)

### Modified Files
- `client/src/pages/settings.tsx` -- replaced with 3-line re-export shim
- `client/src/App.tsx` -- all 17 imports converted to React.lazy(), Suspense wrapper, ErrorBoundary on all routes
- `client/src/components/ErrorBoundary.tsx` -- added context keys for decks, community, settings, onboarding, goals, profile, push
- `client/src/lib/api.ts` -- added ~150 lines of TypeScript interfaces, all fetchAPI<any> replaced with typed generics
- `client/src/pages/profile.tsx` -- removed `as any` from setLocation
- `client/src/pages/coach.tsx` -- replaced subscription `as any` with typed variable
- `client/src/pages/training.tsx` -- removed 5 `as any` casts, added TrainingPlanResponse type imports
- `client/src/pages/goals.tsx` -- replaced `as any` casts with GoalFrequency type and proper typing
- `client/src/components/layout/DashboardLayout.tsx` -- replaced 3 `as any` subscription casts
- `client/src/components/layout/Sidebar.tsx` -- replaced profile `as any` with direct property access
- `client/src/pages/me/useMeData.ts` -- replaced 6 `as any` casts with typed alternatives
- `client/src/hooks/useProfile.ts` -- typed mutation data parameter
- `client/src/lib/analytics/deckStats.ts` -- replaced `as any[]` with `Array<Record<string, unknown>>`
- `server/app.ts` -- integrated sanitizeBodyMiddleware after JSON parsing

## Change Log

| Date | Agent | Change |
|------|-------|--------|
| 2026-02-27 | @po (Pax) | Validated story -- 10/10 checklist PASS. Verdict: GO. Status Draft -> Ready. |
| 2026-02-27 | @dev (Dex) | Implemented all 6 TD items (TD-023, TD-024, TD-029, TD-055, TD-059, TD-060). 16/16 ACs met. Build passes, 19/19 tests pass, 0 `as any` remaining. Status Ready -> InProgress. |
| 2026-02-27 | @qa (Quinn) | QA Gate: **CONCERNS** (approved). 7/7 checks pass. 16/16 ACs verified. Build OK, 19/19 tests pass, 0 `as any` confirmed. 2 LOW concerns: (1) sanitize regex edge case on malformed tags (mitigated by React auto-escaping), (2) ~60 `: any` annotations remain out-of-scope -- recommend follow-up story. No CRITICAL/HIGH issues. Status InProgress -> InReview. |
