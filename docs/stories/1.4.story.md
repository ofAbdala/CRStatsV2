# Story 1.4: Frontend Routing Refactor & E2E Test Foundation

## Status: InProgress
## Priority: P1
## Effort: L (3-5 days)
## Phase: 2

## Description

This story addresses three interconnected concerns: (1) the duplicated auth guard pattern in `App.tsx` that makes adding routes error-prone, (2) the complete absence of frontend and E2E test infrastructure, and (3) per-route rate limiting that can only be properly implemented after the routes.ts split (Story 1.2).

The `<PrivateRoute>` wrapper created here becomes the foundation for code splitting (Story 1.10) and consistent ErrorBoundary coverage (Story 1.10). The E2E test infrastructure becomes the safety net for all subsequent frontend changes.

## Technical Debt Items

- **TD-021:** Route auth guard duplication in `App.tsx` -- all private routes duplicated in `isAuthenticated ? <>...</> : <>...</>` blocks (HIGH)
- **TD-008:** Zero frontend test coverage -- 18 pages, 11 hooks, 14 components with no tests (CRITICAL)
- **TD-005 (Phase 2):** Per-route rate limiting -- stricter limits for AI and public proxy endpoints (CRITICAL, partial)

## Acceptance Criteria

### Frontend Routing
- [x] AC1: A `<PrivateRoute>` (or `<AuthGuard>`) wrapper component exists that checks authentication status and redirects unauthenticated users to `/auth`.
- [x] AC2: Each route is defined exactly once in `App.tsx`. The duplicated `isAuthenticated` conditional block is eliminated.
- [x] AC3: All existing routes continue to work identically (same paths, same components, same auth behavior).

### E2E Test Infrastructure
- [x] AC4: Playwright is installed and configured with a `playwright.config.ts` file.
- [x] AC5: A test helper exists for authenticated sessions (login once, reuse session across tests).
- [x] AC6: At minimum, the following E2E tests exist and pass:
  - Auth flow: login with valid credentials redirects to dashboard
  - Auth flow: unauthenticated access to `/dashboard` redirects to `/auth`
  - Navigation: sidebar links navigate to correct pages (dashboard, push, decks, coach, training, community, settings)
  - Push Analysis: clicking "Push" in sidebar renders the Push Analysis page (regression test for TD-004)
- [x] AC7: `npm run test:e2e` script is added to `package.json`.

### Per-Route Rate Limiting
- [x] AC8: AI endpoints (`/api/coach/chat`, `/api/decks/builder/counter`) have a stricter rate limit of 10 requests per minute per authenticated user.
- [x] AC9: Public proxy endpoints (`/api/clash/*`) have a rate limit of 30 requests per minute per IP.
- [x] AC10: The global rate limit (from Story 1.1) remains as a fallback. Per-route limits are applied as middleware on individual route modules.

## Scope

### IN
- Creating `<PrivateRoute>` wrapper component
- Refactoring `App.tsx` route definitions to use `<PrivateRoute>`
- Setting up Playwright with configuration and test helpers
- Writing initial E2E tests for critical flows
- Adding per-route rate limiting middleware to AI and public proxy endpoints

### OUT
- Comprehensive E2E test coverage (this story establishes infrastructure + critical flow tests)
- Hook tests or component unit tests (can be added incrementally)
- Code splitting / `React.lazy()` (Story 1.10)
- ErrorBoundary wrapping (Story 1.10, will leverage PrivateRoute)

## Dependencies

- Depends on: Story 1.1 (push route must exist, global rate limiting in place), Story 1.2 (route modules must exist for per-route rate limiting)
- Blocks: Story 1.10 (code splitting and ErrorBoundary depend on PrivateRoute)

## Technical Notes

### Key Files Affected
- `client/src/App.tsx` -- route refactoring, PrivateRoute usage
- `client/src/components/auth/PrivateRoute.tsx` -- new: auth guard wrapper
- `playwright.config.ts` -- new: Playwright configuration
- `tests/e2e/` -- new: E2E test directory
- `tests/e2e/auth.spec.ts` -- new: authentication flow tests
- `tests/e2e/navigation.spec.ts` -- new: navigation tests
- `package.json` -- Playwright dependency + test:e2e script
- `server/routes/coach.ts` -- per-route rate limiting
- `server/routes/decks.ts` -- per-route rate limiting
- `server/routes/public.ts` -- per-route rate limiting

### Approach

**PrivateRoute pattern:**
```tsx
function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { isAuthenticated, isLoading } = useAuth();
  if (isLoading) return <LoadingSpinner />;
  if (!isAuthenticated) return <Navigate to="/auth" />;
  return <>{children}</>;
}
```

**Rate limiting pattern (per-route):**
```typescript
import rateLimit from 'express-rate-limit';

const aiLimiter = rateLimit({
  windowMs: 60000,
  max: 10,
  keyGenerator: (req) => req.user?.id || req.ip,
  message: { error: 'Rate limit exceeded for AI endpoints' }
});

router.post('/chat', aiLimiter, async (req, res) => { ... });
```

### Risks
- **Playwright in CI:** Playwright requires browser binaries. Ensure `npx playwright install` is part of the setup. For local development, browsers may need to be installed separately.
- **Auth in E2E tests:** Tests need a way to authenticate. Options: (1) test account with known credentials, (2) mock auth provider, (3) direct API token injection. Choose the approach that works with the existing Clerk/Supabase auth setup.
- **Per-route rate limiting with Story 1.2:** If Story 1.2 is not yet complete when this story starts, per-route rate limiting can be deferred to a follow-up task. The PrivateRoute and E2E infrastructure can proceed independently.

## Definition of Done

- [x] All 3 TD items addressed (TD-021, TD-008 infrastructure, TD-005 per-route)
- [x] PrivateRoute wrapper eliminates route duplication in App.tsx
- [x] Playwright tests run and pass for auth flow and navigation
- [x] Per-route rate limits are active on AI and public proxy endpoints
- [x] All existing tests pass
- [ ] Lint passes
- [x] Type check passes (pre-existing `next/link` error in LastMatches.tsx unrelated)
- [ ] No new CRITICAL issues introduced
- [ ] Code reviewed

## Change Log

| Date | Agent | Change |
|------|-------|--------|
| 2026-02-27 | @po (Pax) | Validated story: 10/10 PASS. Status Draft -> Ready. Verdict: GO. No required fixes. |
| 2026-02-27 | @dev (Dex) | Implemented all 10 ACs. Status Ready -> InProgress. PrivateRoute component created, App.tsx refactored (TD-021), Playwright E2E infra + tests added (TD-008), per-route rate limiting on coach/decks/public routes (TD-005). |
