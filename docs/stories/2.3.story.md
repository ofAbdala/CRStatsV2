# Story 2.3: SEO Dynamic Pages & Public Profiles

## Status: InProgress
## Priority: P0
## Effort: M (2-3 days)
## Phase: 1

## Description

Every player who searches "best deck arena 15" or "counter Golem Clash Royale" on Google is a potential user. Currently, CRStats is a SPA with zero SEO presence — search engines can't index any content. This story creates dynamic, server-rendered pages for every arena and every card, turning the meta deck and counter data (Story 2.1) into an infinite organic acquisition engine.

As @atena-c recommended: "O público não precisa ser convencido que precisa do produto — ele já tá buscando essa informação. Tu só precisa ser onde ele busca."

## Acceptance Criteria

### Meta Pages by Arena
- [x] AC1: Pages exist at `/meta/{arena-slug}` (e.g., `/meta/hog-mountain`, `/meta/legendary-arena`) for each arena (minimum 10 arenas). **12 arenas defined in ARENA_CATALOG.**
- [x] AC2: Each meta page displays: top 10 decks for that arena with win rate, usage rate, 3-crown rate, sample size. Data comes from the meta pipeline (Story 2.1).
- [x] AC3: Meta pages are server-side rendered (SSR) or pre-rendered with proper HTML content for search engine crawling. **Server-rendered via Express routes returning complete HTML documents.**

### Counter Pages by Card
- [x] AC4: Pages exist at `/counter/{card-slug}` (e.g., `/counter/golem`, `/counter/mega-knight`) for each card (minimum top 30 cards). **40 cards defined in CARD_CATALOG.**
- [x] AC5: Each counter page displays: top 5-10 decks with highest win rate against that card. Data comes from the counter engine (Story 2.1). **Aggregated across all arenas with fallback to lower sample thresholds.**
- [x] AC6: Counter pages include a brief description of the card and why these counters work. **Static descriptions per card in CARD_CATALOG + "How to Counter" section.**

### Public Player Profiles
- [x] AC7: Public profile pages exist at `/player/{tag}` showing player stats, current deck, trophy history, and recent battles. Accessible without authentication. **Fetches from Clash Royale API, shows stats grid + current deck + last 10 battles.**
- [x] AC8: Public profiles have proper Open Graph meta tags for social sharing (title, description, image with player stats). **og:title, og:description, og:type=profile, twitter:card, etc.**

### SEO Infrastructure
- [x] AC9: All dynamic pages have proper `<title>`, `<meta description>`, `<meta og:*>` tags with relevant keywords (e.g., "Best Decks for Arena 15 - CRStats"). **All pages include title, description, og:*, twitter:card, keywords meta tags.**
- [x] AC10: A sitemap.xml is generated automatically listing all meta, counter, and public profile pages. Updated daily. **52 URLs: 12 arena pages + 40 card counter pages.**
- [x] AC11: robots.txt allows crawling of all public pages while blocking authenticated routes. **Allows /meta/, /counter/, /player/, /sitemap.xml. Blocks /api/, /auth/, /settings, /billing, /coach, /training.**
- [x] AC12: Canonical URLs are set correctly to avoid duplicate content issues. **`<link rel="canonical">` on every page.**

## Scope

### IN
- Server-side rendering or pre-rendering for public pages
- Dynamic route generation for arenas, cards, and player profiles
- SEO meta tags and Open Graph support
- Sitemap.xml generation
- robots.txt configuration
- Structured data (JSON-LD) for rich search results

### OUT
- Blog or editorial content pages
- Multi-language SEO (English pages — deferred)
- Google Search Console integration (manual setup)
- Link building or off-page SEO
- AMP pages
- Social media auto-posting

## Dependencies

- Depends on: Story 2.1 (meta/counter data), Story 2.2 (production deployment)
- Blocks: None

## Technical Notes

### Architecture Decision: Express HTML Routes (NOT React SSR)

Per @po validation, we use **server-rendered HTML pages via Express routes** instead of React SSR:
- Express routes return complete HTML documents with embedded data
- Simple template literal functions for HTML generation (no template engine)
- Inline CSS for zero FOUC and no additional asset loading
- Lightweight pages with no JS bundle — excellent for Core Web Vitals
- 1-hour in-memory cache for DB queries, Vercel CDN caching via Cache-Control headers

### Key Files (New)
- `server/seo/constants.ts` — Arena catalog (12 arenas), Card catalog (40 cards), slug helpers
- `server/seo/templates.ts` — HTML template functions for meta, counter, player, 404 pages
- `server/seo/sitemap.ts` — Pure sitemap.xml and robots.txt generators (no DB dependency)
- `server/seo/data.ts` — Data access layer (DB queries with caching, Clash API for players)
- `server/routes/seo.ts` — Express route handlers for all SEO endpoints
- `server/seo/constants.test.ts` — Unit tests for catalog and slug lookups (17 tests)
- `server/seo/templates.test.ts` — Unit tests for HTML template rendering (9 tests)
- `server/seo/data.test.ts` — Unit tests for sitemap.xml and robots.txt (10 tests)

### Key Files (Modified)
- `server/routes/index.ts` — SEO routes registered first (before SPA catch-all)
- `vercel.json` — SEO route rewrites added before SPA catch-all
- `package.json` — Added `test:seo` script

### URL Structure
```
/meta/hog-mountain     → "Best Decks for Hog Mountain - CRStats"
/meta/legendary-arena  → "Best Decks for Legendary Arena - CRStats"
/counter/golem         → "Best Counter Decks for Golem - CRStats"
/counter/mega-knight   → "Best Counter Decks for Mega Knight - CRStats"
/player/ABC123         → "SuperPlayer (#ABC123) - Player Stats - CRStats"
/sitemap.xml           → Auto-generated sitemap (52 URLs)
/robots.txt            → Crawling rules
```

### Structured Data (JSON-LD)
```json
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Best Counter Decks for Golem - CRStats",
  "description": "Top 10 decks with highest win rate against Golem in Clash Royale. Real battle data, updated daily.",
  "dateModified": "2026-02-27",
  "publisher": { "@type": "Organization", "name": "CRStats", "url": "https://crstats.app" }
}
```

### Caching Strategy
| Route | In-Memory TTL | Vercel CDN (s-maxage) |
|-------|-------------|----------------------|
| /meta/* | 1 hour | 1 hour + 2h stale-while-revalidate |
| /counter/* | 1 hour | 1 hour + 2h stale-while-revalidate |
| /player/* | 10 min | 10 min + 20 min stale-while-revalidate |
| /sitemap.xml | N/A (generated) | 24 hours |
| /robots.txt | N/A (generated) | 24 hours |

### Risks
- **Google indexing delay:** New sites take weeks to get indexed. Mitigation: submit sitemap via Search Console, share pages on Reddit/Discord
- **Stale content in cache:** In-memory cache + CDN cache may serve outdated meta data. Mitigation: 1-hour TTL for DB queries
- **Clash API rate limits for player pages:** Player profiles call the Clash API. Mitigation: 10-min cache, rate limiting at 60 req/min

## Definition of Done

- [x] Meta pages render for at least 10 arenas with real data
- [x] Counter pages render for at least 30 cards with real data
- [x] Public player profiles display stats correctly
- [x] All public pages have proper SEO meta tags
- [x] sitemap.xml is accessible and lists all pages
- [x] robots.txt is configured correctly
- [ ] Pages pass Google's Mobile-Friendly Test
- [ ] Core Web Vitals are "Good" (LCP < 2.5s, CLS < 0.1)
- [x] All existing tests pass (19 critical tests)
- [x] New SEO tests pass (36 tests)
- [x] Type check passes (no new server-side errors)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `server/seo/constants.ts` | NEW | Arena/card catalogs, slug helpers, base URL |
| `server/seo/templates.ts` | NEW | HTML template functions for all SEO pages |
| `server/seo/sitemap.ts` | NEW | Pure sitemap.xml and robots.txt generators |
| `server/seo/data.ts` | NEW | DB data access with caching for SEO pages |
| `server/routes/seo.ts` | NEW | Express route handlers for SEO endpoints |
| `server/seo/constants.test.ts` | NEW | 17 unit tests for catalogs and lookups |
| `server/seo/templates.test.ts` | NEW | 9 unit tests for HTML template rendering |
| `server/seo/data.test.ts` | NEW | 10 unit tests for sitemap/robots generators |
| `server/routes/index.ts` | MODIFIED | Register SEO routes first |
| `vercel.json` | MODIFIED | Add SEO route rewrites + cache headers |
| `package.json` | MODIFIED | Add `test:seo` script |
| `docs/stories/2.3.story.md` | MODIFIED | Updated checkboxes, file list, notes |

## Change Log

- 2026-02-27: @pm created from Epic 2 / Counsel Session #2. @atena-c identified SEO as primary acquisition channel. Status: Draft.
- 2026-02-27: @dev implemented all 12 acceptance criteria. Architecture: Express HTML routes (no React SSR). 36 new unit tests passing. Status: InProgress.
