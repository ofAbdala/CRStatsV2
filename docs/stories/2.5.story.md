# Story 2.5: Enhanced Push Tracking & Tilt Detection

## Status: InProgress
## Priority: P1
## Effort: M (2-3 days)
## Phase: 2

## Description

Competitive players live for the push — the grind from one trophy milestone to the next. The current push tracking shows basic session data, but lacks the engagement hooks that bring players back daily. This story adds a DailyStatusCard (the first thing users see on login), tilt detection (algorithmically identifying losing streaks and suggesting breaks), and an enhanced trophy progression graph.

As @hormozi-c noted: "Tempo pra resultado = quase zero." The DailyStatusCard shows the player their progress the moment they open CRStats — instant value, instant dopamine.

## Acceptance Criteria

### DailyStatusCard
- [x] AC1: A DailyStatusCard component displays prominently on the dashboard (home page) showing today's push summary: battles played, wins, losses, trophy delta (+ green / - red), win rate percentage.
- [x] AC2: The card updates automatically when the player syncs new data. If no battles today, it shows "No battles yet — good luck on ladder!"
- [x] AC3: The card shows a streak indicator: current winning/losing streak count.

### Tilt Detection
- [x] AC4: The system detects tilt: 3+ consecutive losses within a session. When tilt is detected, a visual indicator appears (e.g., orange/red border on the DailyStatusCard).
- [x] AC5: On tilt detection, the system suggests a break with a friendly message: "You're on a losing streak. Take a 15-minute break — statistically, players who pause recover better."
- [x] AC6: Tilt history is tracked: the "Me" page shows a tilt timeline (dates when tilt was detected and how many trophies were lost during tilt).

### Trophy Progression Graph
- [x] AC7: An enhanced trophy graph on the dashboard shows session-by-session trophy progression (not just daily totals). Each data point represents a play session with its trophy delta.
- [x] AC8: The graph supports zoom levels: today, this week, this season. Default view is "this week."
- [x] AC9: Push balance is displayed alongside the graph: "Push Saldo: +127 trophies this week (32W - 21L)."

### Quick Actions
- [x] AC10: Below the DailyStatusCard, quick action buttons provide contextual suggestions based on the player's current state:
  - After a loss: "Find counter deck" → links to counter page
  - On tilt: "Analyze your losses" → links to push analysis
  - After a win streak: "Keep pushing! You're on fire"
  - No battles today: "Check today's meta" → links to meta page

## Scope

### IN
- DailyStatusCard component with real-time push data
- Tilt detection algorithm (3+ consecutive losses)
- Enhanced trophy progression graph with zoom
- Push balance calculation
- Quick action contextual buttons
- Streak tracking (win/loss)

### OUT
- Push notifications (mobile push alerts)
- Tilt prediction (ML-based)
- Comparison with other players' push performance
- Social sharing of push results
- Custom session markers (manual start/stop of push sessions)

## Dependencies

- Depends on: Story 2.2 (production deployment)
- Blocks: None

## Technical Notes

### Key Files Affected
- `client/src/pages/dashboard.tsx` — DailyStatusCard, quick actions
- `client/src/components/DailyStatusCard.tsx` — new component
- `client/src/components/TrophyGraph.tsx` — new or enhance existing
- `server/domain/tilt.ts` — enhance existing tilt detection
- `server/domain/pushSession.ts` — new: session aggregation
- `server/routes/player.ts` — new endpoint for daily summary

### Tilt Detection Algorithm
```typescript
// Already exists in server/domain/tilt.ts — enhance with:
interface TiltDetection {
  isOnTilt: boolean;
  consecutiveLosses: number;
  trophiesLostDuringTilt: number;
  suggestedAction: 'break' | 'counter' | 'analyze';
}

function detectTilt(battles: Battle[]): TiltDetection {
  const recent = battles.slice(-10);
  let streak = 0;
  let tiltLoss = 0;
  for (const b of recent.reverse()) {
    if (b.result === 'loss') {
      streak++;
      tiltLoss += b.trophyChange;
    } else break;
  }
  return {
    isOnTilt: streak >= 3,
    consecutiveLosses: streak,
    trophiesLostDuringTilt: Math.abs(tiltLoss),
    suggestedAction: streak >= 5 ? 'break' : streak >= 3 ? 'counter' : 'analyze'
  };
}
```

### Risks
- **Session detection:** Clash Royale API doesn't have explicit "session" markers. Mitigation: define session as battles within 30-minute gaps
- **Real-time feel:** Data only updates on sync, not live. Mitigation: auto-sync every 5 minutes when dashboard is open (with rate limit awareness)
- **Graph performance:** Large battle histories could make the graph slow. Mitigation: aggregate by session for chart data, lazy load older data

## Definition of Done

- [x] DailyStatusCard displays on dashboard with today's stats
- [x] Tilt detection works correctly (3+ losses triggers visual indicator)
- [x] Tilt suggestion message appears with contextual advice
- [x] Trophy graph shows session-by-session data with zoom
- [x] Push balance displays correctly
- [x] Quick actions show contextual suggestions
- [x] All existing tests pass
- [x] Lint passes (pre-existing issues only)
- [x] Type check passes (pre-existing issues only)

## File List

### New Files
- `client/src/components/home/DailyStatusCard.tsx` — Hero card: today's stats, tilt indicator, streaks, quick actions (AC1-AC5, AC10)
- `client/src/components/home/MiniGraph.tsx` — Trophy progression chart with zoom levels and push balance (AC7-AC9)
- `client/src/components/home/LastMatches.tsx` — Recent match results quick-view
- `client/src/components/home/DailyInsight.tsx` — Contextual advice card based on daily performance
- `client/src/pages/me/TiltHistory.tsx` — Tilt events timeline for Me page (AC6)
- `server/domain/pushSession.ts` — Session aggregation, daily summary, trophy progression, battle range filtering
- `server/domain/pushSession.test.ts` — Tests for push session logic (11 tests)
- `shared/domain/tilt.test.ts` — Tests for enhanced tilt detection (8 tests)

### Modified Files
- `shared/domain/tilt.ts` — Added TiltDetection, TiltEvent interfaces; detectTilt(), detectTiltHistory() functions
- `server/routes/player.ts` — Added 3 endpoints: daily-summary, trophy-progression, tilt-history
- `client/src/lib/api.ts` — Added API types and client methods for 3 new endpoints
- `client/src/pages/me/MeOverviewTab.tsx` — Integrated TiltHistory component
- `shared/i18n/translations/en-US.json` — Added i18n keys for home components and tilt history
- `shared/i18n/translations/pt-BR.json` — Added i18n keys for home components and tilt history

---

## Change Log

- 2026-02-27: @pm created from Epic 2. Daily engagement hook — the dopamine card. Status: Draft.
- 2026-02-27: @dev implemented all ACs. Enhanced tilt detection, push session aggregation, 3 API endpoints, 4 dashboard components, tilt history on Me page, i18n (en-US + pt-BR), 19 new tests. Status: InProgress.
