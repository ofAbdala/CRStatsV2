# Story 1.11: Comprehensive API Integration Tests

## Status: InReview
## Priority: P2
## Effort: L (3-5 days)
## Phase: 5

## Description

With the route split complete (Story 1.2) and the backend modularized, this story adds the API integration tests that have been completely absent since the project's inception. All 46 API endpoints currently have zero integration tests -- the Stripe webhook handler (which controls subscription state and directly impacts revenue), player sync, coach chat with free limit enforcement, and all CRUD endpoints are completely untested.

This story also fixes the returning-user login redirect (TD-017), which is a straightforward UX fix that was deferred to this phase because it is LOW effort and does not block other work.

## Technical Debt Items

- **TD-007:** Zero API route integration tests -- 46 endpoints untested (CRITICAL)
- **TD-017:** Login redirects to `/onboarding` for returning users -- unnecessary friction (HIGH)

## Acceptance Criteria

### API Integration Tests (TD-007)
- [x] AC1: Integration tests exist using `supertest` for each route module created in Story 1.2.
- [x] AC2: The following critical paths have comprehensive test coverage (priority order):
  1. **Stripe webhook handler:** Tests for `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, and `invoice.payment_failed` events. Verifies subscription state transitions.
  2. **Player sync endpoint:** Tests for successful sync, stale data detection, rate limiting enforcement, and error handling for Clash Royale API failures.
  3. **Coach chat with free limit enforcement:** Tests that free users are limited to `FREE_DAILY_LIMIT` messages per day and that PRO users have no limit. Tests the daily limit reset.
  4. **Deck suggestion with free limit enforcement:** Same as coach chat for deck suggestions.
  5. **Auth user endpoint:** Tests returning-user flow (profile exists) and new-user flow (bootstrap).
  6. **CRUD endpoints:** At least one happy-path test per CRUD route group (settings, goals, training, notifications, favorites).
- [x] AC3: Tests use mocked external services (Clash Royale API, OpenAI, Stripe) -- no real API calls in tests.
- [x] AC4: Test database uses a separate test schema or in-memory approach (not the production database).
- [x] AC5: `npm run test:integration` runs all API integration tests.
- [x] AC6: Total API integration test count is >= 30 tests (59 tests across 11 files).

### Login Redirect Fix (TD-017)
- [x] AC7: After login, if the user already has a `clashTag` in their profile, they are redirected to `/dashboard` instead of `/onboarding`.
- [x] AC8: After login, if the user does NOT have a `clashTag`, they are redirected to `/onboarding` (existing behavior preserved).
- [x] AC9: An E2E test verifies the returning-user redirect behavior (added to the test suite from Story 1.4).

## Scope

### IN
- Writing integration tests for all route modules using `supertest`
- Setting up test database infrastructure (test schema or in-memory)
- Creating mock utilities for Clash Royale API, OpenAI, and Stripe
- Creating test fixtures and helpers (authenticated user creation, subscription states)
- Fixing the login redirect for returning users
- Adding E2E test for returning-user redirect

### OUT
- Load testing or performance testing
- Frontend unit tests (covered by Story 1.4 E2E infrastructure)
- Testing external API integrations with real services
- Refactoring route handlers (test as-is)

## Dependencies

- Depends on: Story 1.2 (route split enables isolated module testing)
- Blocks: None

## Technical Notes

### Key Files Affected
- `tests/integration/` -- new: integration test directory
- `tests/integration/routes/auth.test.ts` -- new
- `tests/integration/routes/billing.test.ts` -- new (Stripe webhook)
- `tests/integration/routes/player.test.ts` -- new
- `tests/integration/routes/coach.test.ts` -- new
- `tests/integration/routes/decks.test.ts` -- new
- `tests/integration/routes/training.test.ts` -- new
- `tests/integration/routes/settings.test.ts` -- new
- `tests/integration/routes/notifications.test.ts` -- new
- `tests/integration/routes/community.test.ts` -- new
- `tests/integration/helpers/` -- new: test utilities (mocks, fixtures, auth)
- `client/src/pages/auth.tsx` -- login redirect fix (~15-20 lines)
- `client/src/hooks/useAuth.ts` -- potentially modify redirect logic
- `package.json` -- `test:integration` script

### Approach

**Test structure per route module:**
```typescript
import request from 'supertest';
import { createTestApp } from '../helpers/app';
import { createTestUser } from '../helpers/auth';

describe('POST /api/coach/chat', () => {
  it('should return AI response for PRO user', async () => { ... });
  it('should enforce daily limit for free user', async () => { ... });
  it('should return 401 for unauthenticated request', async () => { ... });
  it('should handle OpenAI timeout gracefully', async () => { ... });
});
```

**Stripe webhook testing:**
```typescript
it('should create subscription on customer.subscription.created', async () => {
  const event = createStripeEvent('customer.subscription.created', { ... });
  const sig = stripe.webhooks.generateTestHeaderString({ payload: event });
  await request(app)
    .post('/api/billing/webhook')
    .set('stripe-signature', sig)
    .send(event)
    .expect(200);
  // Verify subscription state in test DB
});
```

### Testing Priority
1. Stripe webhook (revenue-critical, highest business risk)
2. Player sync (core feature, data integrity)
3. Coach chat + deck suggestions (free tier enforcement, cost control)
4. Auth endpoint (user flow foundation)
5. CRUD endpoints (basic coverage)

### Risks
- **Test database setup:** Integration tests need a real (or realistic) database. Options: (1) Use a test schema on the development database, (2) Use testcontainers with PostgreSQL, (3) Use a separate Supabase project for testing. Choose based on CI/CD constraints.
- **Auth mocking:** The auth system (likely Clerk or Supabase Auth) needs to be mockable for tests. Create a test auth helper that generates valid JWTs for test users.
- **Test isolation:** Each test should be independent. Use transactions that roll back after each test to avoid test pollution.

## Definition of Done

- [x] TD-007 and TD-017 fully addressed
- [x] >= 30 integration tests exist and pass (59 tests)
- [x] All critical paths have test coverage (Stripe, sync, coach, auth)
- [x] Tests use mocked external services
- [x] Test database is isolated from production (mock storage)
- [x] Login redirect works correctly for returning users
- [x] `npm run test:integration` passes
- [x] All existing tests still pass (19/19)
- [x] Lint passes
- [x] Type check passes
- [x] No new CRITICAL issues introduced
- [x] Code reviewed

---

## Change Log

- 2026-02-27: @po validated -- **GO (10/10)**. All 10 checklist items PASS. 9 ACs are testable and specific (>= 30 integration tests, named critical paths, mocked services, isolated DB, login redirect conditions). TD items (TD-007 CRITICAL, TD-017 HIGH) align with epic and assessment. Dependencies correct (Story 1.2). Status: Draft -> Ready.
- 2026-02-27: @dev (Dex) -- Implemented all 9 ACs. 59 integration tests across 11 route files with 4 test helpers. Login redirect fixed (TD-017): returning users with clashTag → /dashboard. `test:integration` script added. Build passes, 19/19 critical tests pass. Status: Ready -> InProgress.
- 2026-02-27: @qa (Quinn) -- **QA Gate: FAIL**. 5 of 7 Stripe webhook integration tests fail (billing.test.ts tests 8-12). Root cause: `express.raw()` middleware on the webhook route conflicts with the global `express.json()` middleware in createTestApp — the JSON body parser consumes the body before `express.raw()` can provide a Buffer. The `req.url` type guard on `express.json()` does not reliably filter webhook paths in the supertest environment. **54/59 tests pass, 5/59 fail (all in billing.test.ts).** All other checks PASS. Fix the webhook middleware conflict in `tests/integration/helpers/app.ts` and re-submit. Status remains InProgress.
- 2026-02-27: @dev (Dex) -- Fixed billing test failures. Root cause: supertest's `.send(Buffer.from(...))` with `content-type: application/json` JSON-serializes the Buffer to `{"type":"Buffer","data":[...]}`, so the webhook handler parsed `event.type` as `"Buffer"` instead of the actual event type. Fix: send raw JSON string with `type("application/octet-stream")` to bypass supertest's JSON serialization. **59/59 integration tests pass, 19/19 critical tests pass, build passes.**
- 2026-02-27: @qa (Quinn) -- **QA RE-REVIEW: PASS**. All checks verified after billing test fix. (1) 59/59 integration tests pass (duration: 651ms). (2) 19/19 critical domain tests pass. (3) Build passes cleanly — client and server bundles produced without errors. (4) Fix confirmed correct: `makeWebhookRequest` in `billing.test.ts` now calls `.type("application/octet-stream").send(body)` where `body` is a plain JSON string — this forces supertest to send the raw string without JSON-serializing a Buffer object, so `express.raw({ type: "*/*" })` in `app.ts` receives and preserves the payload as a Buffer. Signature validation tests (invalid sig → 400 STRIPE_WEBHOOK_SIGNATURE_INVALID, missing sig → 400 STRIPE_SIGNATURE_MISSING) also use the same pattern correctly. (5) `tests/integration/helpers/app.ts` body parsing middleware is clean — no debug logging, conditional parser correctly routes webhook path through `express.raw()` and all other paths through `express.json()`. All 12 ACs remain satisfied (verified by previous gate). Status: InProgress -> InReview.
