# Story 2.6: Smart Monetization & Two-Tier Paywall

## Status: InProgress
## Priority: P1
## Effort: S (1-2 days)
## Phase: 2

## Description

CRStats currently has a single PRO tier at R$19,90/month. The counsel identified two issues: (1) the paywall triggers at arbitrary points, not at value moments, and (2) R$19,90 is too cheap for competitive players who spend R$50+/month on gems.

This story implements a two-tier pricing structure (PRO + Elite) and a "smart" paywall that triggers at the exact moment the user experiences value — after seeing a counter deck with a high win rate, after the AI coach gives useful advice, after push analysis reveals a pattern.

As @vendedor-c said: "A limitação tem que ser no volume, não no acesso. Deixa ele provar o valor."

## Acceptance Criteria

### Two-Tier Pricing
- [x] AC1: Two subscription tiers exist in Stripe:
  - **PRO** (R$19,90/month or R$159/year): unlimited meta/counter queries, AI coach (unlimited), push analysis, deck optimizer
  - **Elite** (R$39,90/month or R$299/year): everything PRO + training plans, priority coaching responses, advanced analytics (matchup data, season comparisons)
- [x] AC2: The pricing page clearly shows both tiers with feature comparison.
- [x] AC3: Users can upgrade from PRO to Elite (prorated by Stripe).

### Smart Paywall
- [x] AC4: Free users get 5 counter/meta deck queries per day and 5 AI coach messages per day (existing limit maintained).
- [x] AC5: When a free user hits their daily limit, the paywall shows **contextually** — e.g., "You found 3 counter decks today. Unlock unlimited counters for R$19,90/month."
- [x] AC6: The paywall shows the user's recent value: "Today you discovered a 68% WR counter to Mega Knight. Imagine having this data for every card, every day."

### Conversion Triggers
- [x] AC7: A subtle upgrade prompt appears at value moments (non-blocking, dismissible):
  - After a successful counter deck suggestion (user won with the deck)
  - After push analysis reveals an actionable insight
  - After tilt detection suggests a break (and user's next session shows improvement)
- [x] AC8: Conversion prompts have a cooldown: maximum 1 prompt per session, maximum 3 per day.

### Analytics
- [x] AC9: Basic conversion funnel tracking: page view → signup → first query → limit hit → pricing view → checkout → payment.

## Scope

### IN
- Creating Elite tier in Stripe (product + prices)
- Updating subscription middleware to handle two tiers
- Smart paywall UI with contextual messaging
- Conversion trigger system with cooldown
- Pricing page with tier comparison
- Basic funnel tracking (client-side events)

### OUT
- A/B testing of pricing
- Discount codes or referral programs
- Trial periods (free tier serves as trial)
- Team/organization plans
- Lifetime deals
- Payment methods beyond credit card (PIX — deferred)

## Dependencies

- Depends on: Story 2.2 (Stripe production)
- Blocks: None

## Technical Notes

### Key Files Affected
- `server/routes/billing.ts` — add Elite product, upgrade flow
- `client/src/pages/settings.tsx` — pricing page / upgrade UI
- `client/src/components/Paywall.tsx` — new: smart paywall component
- `client/src/components/ConversionPrompt.tsx` — new: contextual upgrade prompt
- `client/src/hooks/useSubscription.ts` — enhance with tier detection
- `shared/contracts/subscription.ts` — add Elite tier type

### Stripe Products Configuration
```
PRO Monthly:  price_pro_monthly  — R$19,90/month
PRO Annual:   price_pro_annual   — R$159/year (33% off)
Elite Monthly: price_elite_monthly — R$39,90/month
Elite Annual:  price_elite_annual  — R$299/year (37% off)
```

### Feature Gating Matrix
| Feature | Free | PRO | Elite |
|---------|:----:|:---:|:-----:|
| Meta decks view | 5/day | Unlimited | Unlimited |
| Counter deck queries | 5/day | Unlimited | Unlimited |
| AI Coach chat | 5/day | Unlimited | Unlimited + priority |
| Push analysis | None | Full | Full |
| Deck optimizer | 5/day | Unlimited | Unlimited |
| Training plans | None | None | Full |
| Advanced analytics | None | None | Full |
| Matchup data | Basic | Basic | Detailed |

### Smart Paywall Logic
```typescript
function getPaywallMessage(context: PaywallContext): string {
  if (context.trigger === 'limit_reached') {
    return `You've used ${context.used}/${context.limit} queries today.
            Unlock unlimited access for R$19,90/month.`;
  }
  if (context.trigger === 'value_moment') {
    return `That ${context.winRate}% counter deck just helped you climb.
            Get unlimited counters for every card.`;
  }
  return 'Upgrade to PRO for unlimited access.';
}
```

### Risks
- **Price sensitivity:** R$39,90 might be too high for Brazilian market. Mitigation: start with both tiers, adjust based on conversion data
- **Over-prompting:** Too many upgrade prompts annoy users. Mitigation: strict cooldown (1/session, 3/day), dismissible, non-blocking

## Definition of Done

- [x] Two tiers (PRO + Elite) configured in Stripe with correct prices
- [x] Pricing page shows both tiers with feature comparison
- [x] Upgrade from PRO to Elite works (prorated)
- [x] Smart paywall shows contextual messages at limit
- [x] Conversion prompts appear at value moments with cooldown
- [x] Feature gating works correctly per tier
- [x] All existing tests pass (24/24 pass)
- [x] Lint passes (no new errors)
- [x] Type check passes (no new errors; 2 pre-existing unrelated module errors)

---

## File List

### Modified
- `shared/pricing.ts` — Added Elite tier pricing config, `SubscriptionTier` type, `ELITE_PRICING`, `hasPaidAccess()`, `hasEliteAccess()`
- `shared/constants/limits.ts` — Unified `TIER_LIMITS` record with feature gating matrix, `getTierLimits()`, `isUnlimited()`
- `shared/schema.ts` — Added 'elite' to subscriptions plan CHECK constraint
- `shared/i18n/translations/pt-BR.json` — Added pricing, paywall, conversion prompt translations
- `shared/i18n/translations/en-US.json` — Added pricing, paywall, conversion prompt translations
- `server/storage.ts` — Added `isElite()`, `getTier()` to IStorage; updated `isPro()` to include elite
- `server/domain/stripeCheckout.ts` — Added Elite price validation, `getPlanFromPriceId()`
- `server/domain/stripeCheckout.test.ts` — Tests for Elite prices, `getPlanFromPriceId()`, deprecated alias
- `server/routes/webhookHandler.ts` — `detectPlanFromSubscription()` for PRO/Elite detection on all events
- `server/routes/billing.ts` — Added `POST /api/stripe/upgrade` route
- `server/routes/auth.ts` — Added `GET /api/subscription/usage` endpoint
- `client/src/App.tsx` — Added `/pricing` route with lazy loading
- `client/src/pages/billing.tsx` — Elite tier display, upgrade button, funnel tracking
- `client/src/lib/api.ts` — Added `subscription.getUsage()` and `stripe.upgrade()` methods
- `.env.example` — Added `STRIPE_ELITE_PRICE_ID`, `STRIPE_ELITE_ANNUAL_PRICE_ID`

### Created
- `client/src/pages/pricing.tsx` — Pricing page with 3-tier comparison, monthly/annual toggle, FAQ
- `client/src/components/Paywall.tsx` — Smart contextual paywall dialog
- `client/src/components/ConversionPrompt.tsx` — Value-moment upgrade prompt with cooldown
- `client/src/lib/funnelTracking.ts` — Client-side funnel event tracking

## Change Log

- 2026-02-27: @pm created from Epic 2 / Counsel Session #2. @vendedor-c recommended two-tier pricing + value-moment paywall. Status: Draft.
- 2026-02-27: @dev implemented all 9 ACs. Elite tier pricing, smart paywall, conversion prompts, pricing page, funnel tracking. 24/24 tests pass. Status: Draft → InProgress.
