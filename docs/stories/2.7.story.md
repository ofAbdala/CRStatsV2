# Story 2.7: Community & Social Features

## Status: Draft
## Priority: P2
## Effort: L (3-5 days)
## Phase: 3

## Description

The community dimension is at 40% — rankings exist but lack the social features that drive retention and organic growth. Competitive players want to track their clan's performance, follow top players' deck choices, and share their own decks with the community. These features turn CRStats from a solo tool into a social platform.

As @atena-c advised: "Discord/Reddit — Comunidade CR já vive lá. Bot que posta meta update diário." The social features built here feed into external community channels.

## Acceptance Criteria

### Clan Tracking
- [ ] AC1: Players can view their clan's stats page: total trophies, member count, war log summary, top members by trophy count.
- [ ] AC2: Clan data is fetched from Clash Royale API (`/v1/clans/{tag}`) and cached (TTL: 1 hour).
- [ ] AC3: Clan members list shows each member's role, trophies, and last active date.

### Follow System
- [ ] AC4: Users can follow other CRStats players (up to 50 follows for free, unlimited for PRO). A "Follow" button appears on public profiles.
- [ ] AC5: A "Following" feed on the dashboard shows recent activity from followed players: trophy changes, new deck used, push sessions.
- [ ] AC6: Follow data is stored in a `follows` table with proper indexes and RLS.

### Deck Sharing
- [ ] AC7: Players can share any deck via a shareable URL: `/deck/{encoded-deck}`. The page shows the deck cards, average elixir, and a "Copy to game" deep link.
- [ ] AC8: Shared decks include community stats if available: win rate, usage count, 3-crown rate from the meta pipeline.
- [ ] AC9: A "Share" button on any deck card generates the shareable link and supports native share API (mobile).

### Community Decks
- [ ] AC10: A "Top Decks" section on the community page shows the most-used and highest-win-rate decks this week, filterable by arena.
- [ ] AC11: Users can "upvote" decks they've used and won with (verified via battle history — prevents fake votes). Top-voted decks are highlighted.

## Scope

### IN
- Clan stats page with member list
- Follow/unfollow system (database + UI)
- Following feed on dashboard
- Deck sharing via URL
- Community top decks with arena filter
- Deck upvoting (battle-verified)

### OUT
- In-app chat or messaging between players
- Clan war strategy planning tools
- Clan management features (invites, kicks — that's in-game)
- Social login (connect Discord/Twitter)
- Leaderboards by region (already exists in community page)
- User-generated guides or content

## Dependencies

- Depends on: Story 2.2 (production), Story 2.4 (stats data for community decks)
- Blocks: None

## Technical Notes

### Key Files Affected
- `client/src/pages/community.tsx` — top decks section, clan page link
- `client/src/pages/clan.tsx` — new: clan stats page
- `client/src/components/FollowButton.tsx` — new
- `client/src/components/DeckShareCard.tsx` — new
- `server/routes/community.ts` — expand with clan, follow, share endpoints
- `shared/schema.ts` — follows table, deck_shares table
- `scripts/supabase/rls-and-triggers.sql` — RLS for new tables

### Database Schema
```sql
CREATE TABLE follows (
  id SERIAL PRIMARY KEY,
  follower_id TEXT NOT NULL REFERENCES profiles(id),
  following_id TEXT NOT NULL REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(follower_id, following_id)
);

CREATE INDEX idx_follows_follower ON follows(follower_id);
CREATE INDEX idx_follows_following ON follows(following_id);

CREATE TABLE deck_votes (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES profiles(id),
  deck_hash TEXT NOT NULL,
  battle_id TEXT NOT NULL,  -- proof of win
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, deck_hash)
);
```

### Clash Royale API - Clan Endpoints
- `GET /v1/clans/{tag}` — clan info + member list
- `GET /v1/clans/{tag}/warlog` — war history
- `GET /v1/clans/{tag}/currentwar` — current war status

### Risks
- **Clan API rate limits:** Additional API calls for clan data. Mitigation: cache aggressively (1 hour TTL), only fetch on demand
- **Follow spam:** Users might follow/unfollow rapidly. Mitigation: rate limit follow actions (10/minute)
- **Fake deck votes:** Upvoting system could be gamed. Mitigation: require battle_id proof — only allow upvote if user actually won with that deck
- **Privacy:** Players might not want to be followed. Mitigation: add "public profile" toggle in settings (default: public)

## Definition of Done

- [ ] Clan stats page shows clan info and members
- [ ] Follow/unfollow works with database persistence
- [ ] Following feed shows recent activity from followed players
- [ ] Deck sharing generates functional URLs
- [ ] Community top decks section shows weekly data
- [ ] Deck upvoting requires battle verification
- [ ] RLS policies active on new tables
- [ ] All existing tests pass
- [ ] New endpoints have integration tests
- [ ] Lint passes
- [ ] Type check passes

---

## Change Log

- 2026-02-27: @pm created from Epic 2. Social retention layer — from solo tool to community platform. Status: Draft.
