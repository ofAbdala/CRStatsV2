# Story 2.7: Community & Social Features

## Status: InProgress
## Priority: P2
## Effort: L (3-5 days)
## Phase: 3

## Description

The community dimension is at 40% — rankings exist but lack the social features that drive retention and organic growth. Competitive players want to track their clan's performance, follow top players' deck choices, and share their own decks with the community. These features turn CRStats from a solo tool into a social platform.

As @atena-c advised: "Discord/Reddit — Comunidade CR já vive lá. Bot que posta meta update diário." The social features built here feed into external community channels.

## Acceptance Criteria

### Clan Tracking
- [x] AC1: Players can view their clan's stats page: total trophies, member count, war log summary, top members by trophy count.
- [x] AC2: Clan data is fetched from Clash Royale API (`/v1/clans/{tag}`) and cached (TTL: 1 hour).
- [x] AC3: Clan members list shows each member's role, trophies, and last active date.

### Follow System
- [x] AC4: Users can follow other CRStats players (up to 50 follows for free, unlimited for PRO). A "Follow" button appears on public profiles.
- [ ] AC5: A "Following" feed on the dashboard shows recent activity from followed players: trophy changes, new deck used, push sessions. *(Deferred — requires activity stream infrastructure not yet built)*
- [x] AC6: Follow data is stored in a `follows` table with proper indexes and RLS.

### Deck Sharing
- [x] AC7: Players can share any deck via a shareable URL: `/deck/{encoded-deck}`. The page shows the deck cards, average elixir, and a "Copy to game" deep link.
- [x] AC8: Shared decks include community stats if available: win rate, usage count, 3-crown rate from the meta pipeline.
- [x] AC9: A "Share" button on any deck card generates the shareable link and supports native share API (mobile).

### Community Decks
- [x] AC10: A "Top Decks" section on the community page shows the most-used and highest-win-rate decks this week, filterable by arena.
- [x] AC11: Users can "upvote" decks they've used and won with (verified via battle history — prevents fake votes). Top-voted decks are highlighted.

## Scope

### IN
- Clan stats page with member list
- Follow/unfollow system (database + UI)
- Following feed on dashboard
- Deck sharing via URL
- Community top decks with arena filter
- Deck upvoting (battle-verified)

### OUT
- In-app chat or messaging between players
- Clan war strategy planning tools
- Clan management features (invites, kicks — that's in-game)
- Social login (connect Discord/Twitter)
- Leaderboards by region (already exists in community page)
- User-generated guides or content

## Dependencies

- Depends on: Story 2.2 (production), Story 2.4 (stats data for community decks)
- Blocks: None

## Technical Notes

### Key Files Affected
- `client/src/pages/community.tsx` — top decks section, clan page link
- `client/src/pages/clan.tsx` — new: clan stats page
- `client/src/components/FollowButton.tsx` — new
- `client/src/components/DeckShareCard.tsx` — new
- `server/routes/community.ts` — expand with clan, follow, share endpoints
- `shared/schema.ts` — follows table, deck_shares table
- `scripts/supabase/rls-and-triggers.sql` — RLS for new tables

### Database Schema
```sql
CREATE TABLE follows (
  id SERIAL PRIMARY KEY,
  follower_id TEXT NOT NULL REFERENCES profiles(id),
  following_id TEXT NOT NULL REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(follower_id, following_id)
);

CREATE INDEX idx_follows_follower ON follows(follower_id);
CREATE INDEX idx_follows_following ON follows(following_id);

CREATE TABLE deck_votes (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES profiles(id),
  deck_hash TEXT NOT NULL,
  battle_id TEXT NOT NULL,  -- proof of win
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, deck_hash)
);
```

### Clash Royale API - Clan Endpoints
- `GET /v1/clans/{tag}` — clan info + member list
- `GET /v1/clans/{tag}/warlog` — war history
- `GET /v1/clans/{tag}/currentwar` — current war status

### Risks
- **Clan API rate limits:** Additional API calls for clan data. Mitigation: cache aggressively (1 hour TTL), only fetch on demand
- **Follow spam:** Users might follow/unfollow rapidly. Mitigation: rate limit follow actions (10/minute)
- **Fake deck votes:** Upvoting system could be gamed. Mitigation: require battle_id proof — only allow upvote if user actually won with that deck
- **Privacy:** Players might not want to be followed. Mitigation: add "public profile" toggle in settings (default: public)

## Definition of Done

- [x] Clan stats page shows clan info and members
- [x] Follow/unfollow works with database persistence
- [ ] Following feed shows recent activity from followed players *(deferred — AC5)*
- [x] Deck sharing generates functional URLs
- [x] Community top decks section shows weekly data
- [x] Deck upvoting requires battle verification
- [ ] RLS policies active on new tables *(SQL documented below, needs migration)*
- [x] All existing tests pass (129/129)
- [x] New endpoints have integration tests (27 new tests)
- [x] Lint passes (only pre-existing errors)
- [x] Type check passes (only pre-existing errors)

## File List

### Modified Files
| File | Changes |
|------|---------|
| `shared/schema.ts` | Added `follows` and `deckVotes` tables, relations, types |
| `shared/constants/limits.ts` | Added `maxFollows` to TierLimits, `FREE_FOLLOW_LIMIT` constant |
| `server/storage.ts` | Added 11 new IStorage methods + DatabaseStorage implementations for follow/vote |
| `server/clashRoyaleApi.ts` | Added `getClanWarLog()`, `getClanCurrentWar()` |
| `server/routes/community.ts` | Added clan, follow, deck share, top decks, vote endpoints + in-memory clan cache |
| `server/routes/seo.ts` | Added `/deck/:encodedDeck` SEO route for crawlable deck share pages |
| `server/seo/templates.ts` | Added `renderDeckSharePage()` HTML template |
| `client/src/lib/api.ts` | Added types (ClanData, FollowingResponse, DeckShareData, TopDecksResponse) + API methods |
| `client/src/App.tsx` | Added lazy-loaded ClanPage and DeckPage routes |
| `client/src/pages/community.tsx` | Added "Top Decks" tab with TopDecksSection, "View Clan" link on clan rankings |
| `tests/integration/helpers/mocks.ts` | Added follow + deckVote mock methods |
| `tests/integration/helpers/app.ts` | Added `mountFollowRoutes()`, `mountTopDecksRoutes()` |

### New Files
| File | Purpose |
|------|---------|
| `server/domain/deckShare.ts` | Deck encode/decode utilities (sorted numeric IDs, card catalog lookup) |
| `client/src/pages/clan.tsx` | Clan stats page: trophies, members, war log, top members |
| `client/src/pages/deck.tsx` | Client-side deck share page |
| `client/src/components/FollowButton.tsx` | Follow/unfollow toggle with optimistic updates |
| `client/src/components/DeckShareCard.tsx` | Share deck via URL with native share API + clipboard fallback |
| `client/src/components/TopDecksSection.tsx` | Top decks with arena filter and vote counts |
| `tests/integration/routes/follow-and-deckvote.test.ts` | 14 integration tests for follow + vote |
| `tests/integration/routes/deck-share.test.ts` | 13 tests for deck encoding/decoding |

## RLS Policies (Pending Migration)

The following RLS policies should be applied when running the migration:

```sql
-- follows table
ALTER TABLE follows ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own follows"
  ON follows FOR SELECT
  USING (auth.uid() = follower_id OR auth.uid() = following_id);

CREATE POLICY "Users can insert their own follows"
  ON follows FOR INSERT
  WITH CHECK (auth.uid() = follower_id);

CREATE POLICY "Users can delete their own follows"
  ON follows FOR DELETE
  USING (auth.uid() = follower_id);

-- deck_votes table
ALTER TABLE deck_votes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view all deck votes"
  ON deck_votes FOR SELECT
  USING (true);

CREATE POLICY "Users can insert their own votes"
  ON deck_votes FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own votes"
  ON deck_votes FOR DELETE
  USING (auth.uid() = user_id);
```

---

## Change Log

- 2026-02-27: @pm created from Epic 2. Social retention layer — from solo tool to community platform. Status: Draft.
- 2026-02-27: @dev implemented AC1-AC4, AC6-AC11. Schema, storage, API routes, SEO deck page, client components, integration tests (27 new). AC5 deferred (requires activity stream). RLS documented but pending migration. Status: Draft -> InProgress.
