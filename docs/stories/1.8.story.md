# Story 1.8: Complete i18n Coverage Sweep

## Status: Done
## Priority: P1
## Effort: M (2-4 days)
## Phase: 3C

## Description

After Story 1.1 fixed auth.tsx and Story 1.6 fixed me.tsx, three pages and one server-side module still have i18n gaps. This story completes the i18n sweep to achieve 100% translation coverage across all user-facing strings.

The most impactful item is `goals.tsx` with 46 `isPt ? "..." : "..."` ternary hacks -- a pattern that is brittle, error-prone, and does not scale to additional locales. The hook toast i18n (TD-031) depends on Story 1.5 having unified the toast system. The server-side notification strings (TD-035) can be fixed now that route modules exist (Story 1.2).

## Technical Debt Items

- **TD-011:** `goals.tsx` uses 46 `isPt` ternaries instead of `t()` (HIGH)
- **TD-031:** Hooks use hardcoded Portuguese toasts -- 14 strings in `useProfile`, `useGoals`, `useFavorites` (MEDIUM)
- **TD-035:** Server-side hardcoded Portuguese notification strings -- 3 Stripe webhook notifications (MEDIUM)
- **TD-047:** `push.tsx` has Portuguese-only strings -- 3 PT + 1 EN hardcoded (LOW)

## Acceptance Criteria

### goals.tsx (TD-011)
- [x] AC1: All 46 `isPt ? "..." : "..."` ternary expressions in `goals.tsx` are replaced with `t("pages.goals.xxx")` calls.
- [x] AC2: Corresponding translation keys exist in both `pt-BR.json` and `en-US.json`.
- [x] AC3: The goals page displays entirely in the selected locale with no mixed language content.

### Hook Toasts (TD-031)
- [x] AC4: `useProfile.ts`, `useGoals.ts`, and `useFavorites.ts` use `t()` calls for all toast messages instead of hardcoded Portuguese strings.
- [x] AC5: Toast messages are displayed via the unified Radix/`useToast` system (Story 1.5 removed Sonner).
- [x] AC6: All 14 previously hardcoded toast strings have translation keys in both locale files.

### Server-Side Notifications (TD-035)
- [x] AC7: The 3 Stripe webhook notification strings ("Sua assinatura PRO foi ativada...", "Sua assinatura PRO foi cancelada...", "O pagamento da sua assinatura PRO falhou...") use i18n-aware templates.
- [x] AC8: The user's preferred locale is read from `user_settings.preferred_language` before creating the notification text.
- [x] AC9: Both PT-BR and EN-US notification templates exist.

### push.tsx (TD-047)
- [x] AC10: All 4 hardcoded strings in `push.tsx` (3 Portuguese + 1 English) are replaced with `t()` calls.
- [x] AC11: Corresponding translation keys exist in both locale files.

### Overall
- [x] AC12: A full audit confirms no remaining hardcoded Portuguese strings exist outside the translation JSON files. Search patterns: `"` followed by Portuguese characters (ã, ç, é, ó, ú, â, ê, ô, í) in `.tsx` and `.ts` files.

## Scope

### IN
- Migrating 46 `isPt` ternaries in `goals.tsx` to `t()` calls
- Migrating 14 hook toast strings to `t()` calls (using Radix toast)
- Adding i18n-aware notification templates for Stripe webhook events
- Migrating 4 strings in `push.tsx` to `t()` calls
- Adding all corresponding keys to `pt-BR.json` and `en-US.json`
- Final audit for any remaining hardcoded Portuguese strings

### OUT
- Structural changes to goals.tsx or push.tsx (only string replacement)
- Adding third-language support
- Refactoring the notification creation system

## Dependencies

- Depends on: Story 1.2 (route modules for server-side notification access), Story 1.5 (TD-016 toast unification for hook toasts)
- Blocks: None

## Technical Notes

### Key Files Affected
- `client/src/pages/goals.tsx` -- 46 ternary replacements (432 lines)
- `client/src/pages/push.tsx` -- 4 string replacements (129 lines)
- `client/src/hooks/useProfile.ts` -- toast i18n migration
- `client/src/hooks/useGoals.ts` -- toast i18n migration
- `client/src/hooks/useFavorites.ts` -- toast i18n migration
- `server/routes/billing.ts` (or wherever Stripe webhook handler lives after split) -- notification i18n
- `shared/i18n/translations/pt-BR.json` -- add keys
- `shared/i18n/translations/en-US.json` -- add keys

### Approach
1. **goals.tsx first** -- largest item (46 replacements), most mechanical
2. **Hook toasts second** -- 14 replacements, now using Radix toast
3. **push.tsx third** -- 4 replacements, smallest
4. **Server-side notifications last** -- requires reading user locale from database
5. **Final audit** -- grep for Portuguese character patterns to find any stragglers

### Translation Key Naming Convention
Follow the existing pattern in the i18n files:
- Page strings: `pages.goals.xxx`, `pages.push.xxx`
- Hook strings: `hooks.profile.xxx`, `hooks.goals.xxx`, `hooks.favorites.xxx`
- Server notifications: `notifications.billing.xxx`

### Risks
- **goals.tsx 46 ternaries:** Mechanical but tedious. Each ternary must be carefully matched to the correct translation key. Test each section after migration.
- **Server-side i18n (TD-035):** The server does not have the same i18n infrastructure as the client. Need to either: (a) create a minimal server-side translation resolver that reads the JSON files, or (b) use simple template strings with locale-based selection. Option (b) is simpler and sufficient for 3 strings.

## Definition of Done

- [x] All 4 TD items addressed
- [x] Zero `isPt` ternaries remain in goals.tsx
- [x] Zero hardcoded Portuguese strings in hooks
- [x] Server-side notifications are locale-aware
- [x] push.tsx is fully i18n compliant
- [x] Final audit finds no remaining hardcoded Portuguese in .tsx/.ts files
- [x] All existing tests pass
- [x] Lint passes
- [x] Type check passes
- [x] No new CRITICAL issues introduced
- [x] Code reviewed

## Change Log

| Date | Agent | Change |
|------|-------|--------|
| 2026-02-27 | @po (Pax) | Validated story (10/10). Status: Draft -> Ready. Verdict: GO. |
| 2026-02-27 | @dev (Dex) | Implementation complete. All isPt ternaries removed from goals.tsx, push.tsx/PushSessionList/PushTimeline migrated, hooks + server notifications already done from prior stories. 55 translation keys added to both locale files. Status: Ready -> InProgress. |
| 2026-02-27 | @qa (Quinn) | **QA Gate: PASS.** 7/7 checks passed. Code review: all t() calls use correct key prefixes (pages.goals.*, pages.push.*, hooks.*, notifications.billing.*), clean imports, no structural changes. Tests: 19/19 pass. Build: clean. AC1-AC12 verified: zero isPt in goals.tsx/push.tsx/hooks/entire client/src, all keys present in both pt-BR.json and en-US.json, server-side notifications use i18n key references, zero hardcoded Portuguese in .tsx/.ts files. No regressions, no performance or security issues. Status: InProgress -> InReview. |
