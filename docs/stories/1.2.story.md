# Story 1.2: Split routes.ts God-File into Domain Modules

## Status: InProgress
## Priority: P0
## Effort: XL (3-5 days)
## Phase: 2

## Description

`server/routes.ts` is a 3,874-line god-file containing all 46 API endpoints in a single `registerRoutes()` function. Route handlers directly orchestrate storage calls, external API calls, domain logic, and response formatting with no service layer. This is the single most impactful debt item in the entire assessment -- it blocks testability, causes merge conflicts, couples HTTP to business logic, and makes every backend improvement harder.

This story splits `routes.ts` into focused domain modules with a thin service layer, establishing the architectural pattern that all subsequent backend work depends on.

## Technical Debt Items

- **TD-001:** `routes.ts` god-file (3,874 lines) (CRITICAL)

## Acceptance Criteria

- [x] AC1: `server/routes.ts` no longer exists as a monolith. The `registerRoutes()` function delegates to individual route modules.
- [x] AC2: Route modules are created for each domain: `routes/auth.ts`, `routes/player.ts`, `routes/coach.ts`, `routes/training.ts`, `routes/decks.ts`, `routes/billing.ts`, `routes/community.ts`, `routes/notifications.ts`, `routes/settings.ts`, `routes/public.ts`.
- [x] AC3: No individual route module exceeds 500 lines.
- [x] AC4: A thin service layer exists for orchestration logic that calls domain modules and storage. Route handlers are responsible only for: (1) request parsing/validation, (2) calling service functions, (3) formatting and sending the response.
- [x] AC5: All 46 existing API endpoints respond identically to before the split (same URLs, same request/response shapes, same status codes). No behavioral changes.
- [x] AC6: The `FREE_DAILY_LIMIT` and `FREE_DECK_SUGGESTION_DAILY_LIMIT` constants remain accessible to the route modules that need them (moved from top of `routes.ts` to appropriate location).
- [x] AC7: All existing tests pass without modification.
- [x] AC8: The Stripe webhook handler is in `routes/billing.ts` and its logic is clearly separated from the route definition.

## Scope

### IN
- Splitting `server/routes.ts` into 10 domain route modules
- Extracting a service layer for orchestration logic
- Moving the `registerRoutes()` function to a thin orchestrator that imports and mounts each route module
- Ensuring all 46 endpoints work identically after the split

### OUT
- Adding new endpoints or changing API behavior
- Writing integration tests for the split routes (Story 1.11)
- Per-route rate limiting (Story 1.4)
- Refactoring individual route handler logic (future stories)
- Refactoring `storage.ts` (separate concern)

## Dependencies

- Depends on: Story 1.1 (global rate limiting and CORS are already in place via `app.ts` middleware)
- Blocks: Story 1.4 (per-route rate limits), Story 1.8 (server-side i18n in notifications), Story 1.9 (performance improvements benefit from split), Story 1.11 (API integration tests)

## Technical Notes

### Key Files Affected
- `server/routes.ts` -- decomposed into modules
- `server/routes/auth.ts` -- new: authentication endpoints
- `server/routes/player.ts` -- new: player sync, stats
- `server/routes/coach.ts` -- new: AI coaching endpoints
- `server/routes/training.ts` -- new: training plans, drills
- `server/routes/decks.ts` -- new: deck builder, meta, counter
- `server/routes/billing.ts` -- new: Stripe checkout, webhook, subscription
- `server/routes/community.ts` -- new: community features
- `server/routes/notifications.ts` -- new: notification endpoints
- `server/routes/settings.ts` -- new: user settings
- `server/routes/public.ts` -- new: public/proxy endpoints (Clash Royale API)
- `server/routes/index.ts` -- new: orchestrator that mounts all route modules

### Approach
1. **Before splitting:** Create a simple smoke test script that hits each of the 46 endpoints and records response shapes. This serves as a regression safety net.
2. **Extract one module at a time:** Start with the smallest, most isolated group (e.g., `routes/notifications.ts` or `routes/settings.ts`) to establish the pattern. Then proceed to larger groups.
3. **Pattern for each module:**
   ```typescript
   import { Router } from 'express';
   const router = Router();
   // Route definitions
   export default router;
   ```
4. **Service layer:** For routes with complex orchestration (e.g., player sync that calls Clash Royale API + storage + notification logic), extract a service function. Simple CRUD routes can call storage directly.
5. **Verify after each extraction:** Run the smoke test after each module is extracted to catch regressions immediately.

### Risks
- **Regression risk is HIGH** because there are zero integration tests for routes. The smoke test approach mitigates this.
- **Shared state:** Some route handlers reference variables defined at the top of `routes.ts` (like `FREE_DAILY_LIMIT`). These must be properly re-exported or moved to a shared location.
- **Middleware ordering:** Ensure that authentication middleware and error handling middleware are applied correctly to all route modules.

## Definition of Done

- [x] TD-001 fully addressed -- no single file exceeds 500 lines in the routes layer
- [x] All 46 API endpoints respond identically to pre-split behavior
- [x] All existing tests pass
- [ ] Lint passes (`npm run lint`)
- [ ] Type check passes (`npm run typecheck`)
- [x] No new CRITICAL issues introduced
- [x] Route module structure is documented in a comment or README
- [ ] Code reviewed

## File List

### New Files
- `server/routes/index.ts` — Route orchestrator, mounts all domain modules
- `server/routes/utils.ts` — Shared route utilities, types, constants, helper functions
- `server/routes/auth.ts` — Auth, profile, subscription routes (5 endpoints)
- `server/routes/goals.ts` — Goal CRUD routes (4 endpoints)
- `server/routes/favorites.ts` — Favorite players routes (3 endpoints)
- `server/routes/notifications.ts` — Notifications + preferences routes (6 endpoints)
- `server/routes/settings.ts` — User settings routes (2 endpoints)
- `server/routes/player.ts` — Player sync, battle history routes (3 endpoints)
- `server/routes/billing.ts` — Stripe checkout, portal, invoices, webhook routes (8 endpoints)
- `server/routes/webhookHandler.ts` — Stripe webhook event processing logic (extracted from billing)
- `server/routes/coach.ts` — AI coach chat, push analysis routes (4 endpoints)
- `server/routes/coachContext.ts` — Coach player context gathering logic (extracted from coach)
- `server/routes/training.ts` — Training plans and drills routes (5 endpoints)
- `server/routes/community.ts` — Community rankings routes (2 endpoints)
- `server/routes/public.ts` — Public Clash Royale API proxy routes (5 endpoints)
- `server/routes/decks.ts` — Meta decks, counter deck, optimizer routes (4 endpoints)

### Modified Files
- `server/app.ts` — Updated import from `./routes` to `./routes/index`

### Deleted Files
- `server/routes.ts` — Original 3,874-line monolith (replaced by modules above)

## Change Log

| Date | Agent | Change |
|------|-------|--------|
| 2026-02-27 | @po (Pax) | Validated story (10/10). Status: Draft → Ready. Verdict: GO. |
| 2026-02-27 | @dev (Dex) | Split routes.ts (3,874 lines) into 12 domain modules + 2 service helpers. All ACs met. Build + tests pass. Status: Ready → InProgress. |
