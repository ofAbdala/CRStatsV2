# CRStats Database Schema Documentation

> **Generated by:** @data-engineer (Dara) -- Brownfield Discovery Phase 2
> **Date:** 2026-02-27
> **ORM:** Drizzle ORM v0.39.3 + drizzle-kit v0.31.4
> **Database:** PostgreSQL (Supabase-hosted)
> **Schema source:** `shared/schema.ts`

---

## Table of Contents

1. [Overview](#overview)
2. [Tables](#tables)
3. [Indexes](#indexes)
4. [Foreign Keys & Relationships](#foreign-keys--relationships)
5. [Entity Relationship Diagram](#entity-relationship-diagram)
6. [Zod Validators](#zod-validators)
7. [Enums & Constants](#enums--constants)
8. [Drizzle Relations (ORM-level)](#drizzle-relations-orm-level)

---

## Overview

The CRStats database consists of **16 tables** organized into the following domains:

| Domain | Tables | Purpose |
|--------|--------|---------|
| **Auth & Identity** | `users`, `profiles` | User accounts and player identity |
| **Subscription** | `subscriptions` | Stripe billing and plan management |
| **Preferences** | `user_settings`, `notification_preferences` | User configuration |
| **Game Data** | `favorite_players`, `battle_history`, `player_sync_state` | Clash Royale player data |
| **Coaching** | `coach_messages`, `push_analyses` | AI coaching conversations and session analysis |
| **Training** | `training_plans`, `training_drills` | Training plan management |
| **Community** | `goals`, `notifications` | Goals tracking, in-app notifications |
| **Meta / Cache** | `meta_decks_cache`, `deck_suggestions_usage` | Global deck meta cache, free-tier rate limiting |

---

## Tables

### 1. `users`

Core user table. Source of truth is Supabase `auth.users`; this table mirrors the id for app-level data.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | -- | **PK** |
| `email` | `varchar` | YES | -- | **UNIQUE** |
| `first_name` | `varchar` | YES | -- | |
| `last_name` | `varchar` | YES | -- | |
| `profile_image_url` | `varchar` | YES | -- | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `UpsertUser` (insert), `User` (select)

---

### 2. `profiles`

Player profile with Clash Royale tag binding.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `user_id` | `varchar` | NO | -- | **PK**, FK -> `users.id` ON DELETE CASCADE |
| `display_name` | `varchar` | YES | -- | |
| `clash_tag` | `varchar` | YES | -- | |
| `default_player_tag` | `varchar` | YES | -- | |
| `region` | `varchar` | YES | `'BR'` | |
| `language` | `varchar` | YES | `'pt'` | |
| `role` | `varchar` | YES | `'user'` | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertProfile`, `Profile`

**Note:** `clash_tag` and `default_player_tag` are kept in sync by `buildCanonicalProfileData()` in `storage.ts`. `default_player_tag` is the canonical field; `clash_tag` is a legacy alias.

---

### 3. `subscriptions`

Stripe subscription state.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `stripe_customer_id` | `varchar` | YES | -- | |
| `stripe_subscription_id` | `varchar` | YES | -- | **UNIQUE** |
| `plan` | `varchar` | NO | `'free'` | |
| `status` | `varchar` | NO | `'inactive'` | |
| `current_period_end` | `timestamp` | YES | -- | |
| `cancel_at_period_end` | `boolean` | YES | `false` | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertSubscription`, `Subscription`

---

### 4. `goals`

User-defined goals (trophy targets, win streaks, etc.).

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `title` | `text` | NO | -- | |
| `description` | `text` | YES | -- | |
| `type` | `varchar` | NO | -- | |
| `target_value` | `integer` | NO | -- | |
| `current_value` | `integer` | YES | `0` | |
| `completed` | `boolean` | YES | `false` | |
| `completed_at` | `timestamp` | YES | -- | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertGoal`, `Goal`

---

### 5. `favorite_players`

Tracked/favorite Clash Royale players.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `player_tag` | `varchar` | NO | -- | |
| `name` | `varchar` | NO | -- | |
| `trophies` | `integer` | YES | -- | |
| `clan` | `varchar` | YES | -- | |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertFavoritePlayer`, `FavoritePlayer`

---

### 6. `notifications`

In-app notification inbox.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `title` | `text` | NO | -- | |
| `description` | `text` | YES | -- | |
| `type` | `varchar` | NO | -- | |
| `read` | `boolean` | YES | `false` | |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertNotification`, `Notification`

---

### 7. `user_settings`

UI preferences and notification toggles.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `user_id` | `varchar` | NO | -- | **PK**, FK -> `users.id` ON DELETE CASCADE |
| `theme` | `varchar` | YES | `'dark'` | |
| `preferred_language` | `varchar` | YES | `'pt'` | |
| `default_landing_page` | `varchar` | YES | `'dashboard'` | |
| `show_advanced_stats` | `boolean` | YES | `false` | |
| `notifications_enabled` | `boolean` | YES | `true` | |
| `notifications_training` | `boolean` | YES | `true` | |
| `notifications_billing` | `boolean` | YES | `true` | |
| `notifications_system` | `boolean` | YES | `true` | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertUserSettings`, `UserSettings`

---

### 8. `notification_preferences`

Granular notification opt-in/opt-out per category.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `user_id` | `varchar` | NO | -- | **PK**, FK -> `users.id` ON DELETE CASCADE |
| `training` | `boolean` | NO | `true` | |
| `billing` | `boolean` | NO | `true` | |
| `system` | `boolean` | NO | `true` | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertNotificationPreferences`, `NotificationPreferences`

---

### 9. `player_sync_state`

Tracks the last time player data was synced from the Clash Royale API.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `user_id` | `varchar` | NO | -- | **PK**, FK -> `users.id` ON DELETE CASCADE |
| `last_synced_at` | `timestamp` | YES | -- | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertPlayerSyncState`, `PlayerSyncState`

---

### 10. `battle_history`

Stored battle log entries (JSON blobs from Clash Royale API).

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `player_tag` | `varchar` | NO | -- | |
| `battle_time` | `timestamp` | NO | -- | |
| `battle_key` | `varchar` | NO | -- | **UNIQUE** (SHA-256 dedup key) |
| `battle_json` | `jsonb` | NO | -- | Full battle payload from CR API |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertBattleHistory`, `BattleHistory`

**Note:** `battle_key` is a SHA-256 hash built from userId + playerTag + battleTime + game mode + both sides' crowns, trophyChange, tags, and card ids. This prevents duplicate insertion.

---

### 11. `coach_messages`

AI coach conversation history.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `role` | `varchar` | NO | -- | |
| `content` | `text` | NO | -- | |
| `context_type` | `varchar` | YES | -- | |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertCoachMessage`, `CoachMessage`

---

### 12. `push_analyses`

AI-generated push session analysis results.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `push_start_time` | `timestamp` | NO | -- | |
| `push_end_time` | `timestamp` | NO | -- | |
| `battles_count` | `integer` | NO | -- | |
| `wins` | `integer` | NO | -- | |
| `losses` | `integer` | NO | -- | |
| `net_trophies` | `integer` | NO | -- | |
| `result_json` | `jsonb` | NO | -- | Full AI analysis result |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertPushAnalysis`, `PushAnalysis`

---

### 13. `training_plans`

AI-generated or manually created training plans.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `title` | `varchar` | NO | -- | |
| `source` | `varchar` | NO | `'manual'` | |
| `status` | `varchar` | NO | `'active'` | |
| `push_analysis_id` | `varchar` | YES | -- | FK -> `push_analyses.id` ON DELETE SET NULL |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertTrainingPlan`, `TrainingPlan`

---

### 14. `training_drills`

Individual exercises/drills within a training plan.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `plan_id` | `varchar` | NO | -- | FK -> `training_plans.id` ON DELETE CASCADE |
| `focus_area` | `varchar` | NO | -- | |
| `description` | `text` | NO | -- | |
| `target_games` | `integer` | NO | -- | |
| `completed_games` | `integer` | NO | `0` | |
| `mode` | `varchar` | NO | -- | |
| `priority` | `integer` | NO | `1` | |
| `status` | `varchar` | NO | `'pending'` | |
| `created_at` | `timestamp` | YES | `now()` | |
| `updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertTrainingDrill`, `TrainingDrill`

---

### 15. `meta_decks_cache`

Global cache of meta deck statistics aggregated from top player battle logs.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `deck_hash` | `varchar` | NO | -- | **UNIQUE** (pipe-separated sorted card names) |
| `cards` | `jsonb` | NO | -- | `string[]` array of card names |
| `usage_count` | `integer` | NO | `0` | Number of games observed |
| `avg_trophies` | `integer` | YES | -- | |
| `archetype` | `varchar` | YES | -- | |
| `wins` | `integer` | NO | `0` | |
| `losses` | `integer` | NO | `0` | |
| `draws` | `integer` | NO | `0` | |
| `avg_elixir` | `real` | YES | -- | |
| `win_rate_estimate` | `real` | YES | -- | Laplace-smoothed: `(wins+1)/(games+2)*100` |
| `source_region` | `varchar` | YES | -- | |
| `source_range` | `varchar` | YES | -- | |
| `last_updated_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertMetaDeckCache`, `MetaDeckCache`

**Note:** This table is periodically wiped and rebuilt by `metaDecksRefresh.ts` using a `pg_try_advisory_lock` to prevent concurrent refreshes. Maximum 50 rows are kept.

---

### 16. `deck_suggestions_usage`

Tracks daily usage of free-tier deck suggestion features for rate limiting.

| Column | Type | Nullable | Default | Constraints |
|--------|------|----------|---------|-------------|
| `id` | `varchar` | NO | `gen_random_uuid()` | **PK** |
| `user_id` | `varchar` | NO | -- | FK -> `users.id` ON DELETE CASCADE |
| `suggestion_type` | `varchar` | NO | -- | |
| `created_at` | `timestamp` | YES | `now()` | |

**Types exported:** `InsertDeckSuggestionsUsage`, `DeckSuggestionsUsage`

---

## Indexes

All indexes are defined in the schema (Drizzle `index()` / `uniqueIndex()` calls):

| Index Name | Table | Columns | Type |
|------------|-------|---------|------|
| `users_email_unique` | `users` | `email` | UNIQUE (implicit) |
| `subscriptions_stripe_subscription_id_unique` | `subscriptions` | `stripe_subscription_id` | UNIQUE (implicit) |
| `IDX_subscriptions_user_id` | `subscriptions` | `user_id` | BTREE |
| `IDX_goals_user_id` | `goals` | `user_id` | BTREE |
| `IDX_favorite_players_user_id` | `favorite_players` | `user_id` | BTREE |
| `UIDX_favorite_players_user_id_player_tag` | `favorite_players` | `user_id`, `player_tag` | UNIQUE |
| `IDX_notifications_user_id` | `notifications` | `user_id` | BTREE |
| `IDX_battle_history_user_tag_time` | `battle_history` | `user_id`, `player_tag`, `battle_time` | BTREE (composite) |
| `battle_history_battle_key_unique` | `battle_history` | `battle_key` | UNIQUE (implicit) |
| `IDX_coach_messages_user_id` | `coach_messages` | `user_id` | BTREE |
| `IDX_push_analyses_user_id` | `push_analyses` | `user_id` | BTREE |
| `IDX_training_plans_user_id` | `training_plans` | `user_id` | BTREE |
| `IDX_training_drills_plan_id` | `training_drills` | `plan_id` | BTREE |
| `meta_decks_cache_deck_hash_unique` | `meta_decks_cache` | `deck_hash` | UNIQUE (implicit) |
| `IDX_deck_suggestions_usage_user_type_created` | `deck_suggestions_usage` | `user_id`, `suggestion_type`, `created_at` | BTREE (composite) |

---

## Foreign Keys & Relationships

### Foreign Key Constraints

| Source Table | Source Column | Target Table | Target Column | On Delete |
|-------------|-------------|-------------|-------------|-----------|
| `profiles` | `user_id` | `users` | `id` | CASCADE |
| `subscriptions` | `user_id` | `users` | `id` | CASCADE |
| `goals` | `user_id` | `users` | `id` | CASCADE |
| `favorite_players` | `user_id` | `users` | `id` | CASCADE |
| `notifications` | `user_id` | `users` | `id` | CASCADE |
| `user_settings` | `user_id` | `users` | `id` | CASCADE |
| `notification_preferences` | `user_id` | `users` | `id` | CASCADE |
| `player_sync_state` | `user_id` | `users` | `id` | CASCADE |
| `battle_history` | `user_id` | `users` | `id` | CASCADE |
| `coach_messages` | `user_id` | `users` | `id` | CASCADE |
| `push_analyses` | `user_id` | `users` | `id` | CASCADE |
| `training_plans` | `user_id` | `users` | `id` | CASCADE |
| `training_plans` | `push_analysis_id` | `push_analyses` | `id` | SET NULL |
| `training_drills` | `plan_id` | `training_plans` | `id` | CASCADE |
| `deck_suggestions_usage` | `user_id` | `users` | `id` | CASCADE |

### Relationship Cardinality

| Parent | Child | Cardinality |
|--------|-------|-------------|
| `users` | `profiles` | 1:1 |
| `users` | `subscriptions` | 1:N (latest is active) |
| `users` | `user_settings` | 1:1 |
| `users` | `notification_preferences` | 1:1 |
| `users` | `player_sync_state` | 1:1 |
| `users` | `goals` | 1:N |
| `users` | `favorite_players` | 1:N |
| `users` | `notifications` | 1:N |
| `users` | `battle_history` | 1:N |
| `users` | `coach_messages` | 1:N |
| `users` | `push_analyses` | 1:N |
| `users` | `training_plans` | 1:N |
| `training_plans` | `training_drills` | 1:N |
| `push_analyses` | `training_plans` | 1:N (optional link) |
| `meta_decks_cache` | -- | standalone (global cache) |
| `deck_suggestions_usage` | -- | user-owned rate limiter |

---

## Entity Relationship Diagram

```
                              +------------------+
                              |      users       |
                              |------------------|
                              | id (PK)          |
                              | email (UNIQUE)   |
                              | first_name       |
                              | last_name        |
                              | profile_image_url|
                              | created_at       |
                              | updated_at       |
                              +--------+---------+
                                       |
           +---------------------------+---------------------------+
           |           |               |               |           |
     +-----v------+ +--v---------+ +--v---------+ +---v--------+ |
     |  profiles   | |subscriptions| |user_settings| |notif_prefs | |
     |  (1:1)     | |  (1:N)     | |  (1:1)     | |  (1:1)     | |
     +------------+ +------------+ +------------+ +------------+ |
                                                                  |
     +------------------------------------------------------------+
     |              |               |              |
+----v------+ +----v--------+ +----v--------+ +---v-----------+
|   goals   | |fav_players  | |notifications| |player_sync_st |
|   (1:N)   | |  (1:N)      | |  (1:N)      | |  (1:1)        |
+-----------+ +-------------+ +-------------+ +---------------+
     |
     +---+----------------+-------------------+
         |                |                   |
    +----v--------+  +----v--------+  +------v----------+
    |battle_hist  |  |coach_msgs   |  |push_analyses    |
    |  (1:N)      |  |  (1:N)      |  |  (1:N)          |
    +-------------+  +-------------+  +--------+--------+
                                               |
                                        +------v--------+
                                        |training_plans |
                                        |  (1:N)        |
                                        +--------+------+
                                                 |
                                          +------v--------+
                                          |training_drills|
                                          |  (1:N)        |
                                          +---------------+

    +------------------+     +------------------------+
    | meta_decks_cache |     | deck_suggestions_usage |
    | (standalone)     |     | (user-owned)           |
    +------------------+     +------------------------+
```

---

## Zod Validators

### Insert Schemas (from `drizzle-zod`)

Each table has an auto-generated insert schema with specific fields omitted:

| Schema | Source Table | Omitted Fields |
|--------|-------------|----------------|
| `insertProfileSchema` | `profiles` | `createdAt`, `updatedAt` |
| `insertSubscriptionSchema` | `subscriptions` | `id`, `createdAt`, `updatedAt` |
| `insertGoalSchema` | `goals` | `id`, `createdAt`, `updatedAt` |
| `insertFavoritePlayerSchema` | `favoritePlayers` | `id`, `createdAt` |
| `insertNotificationSchema` | `notifications` | `id`, `createdAt` |
| `insertUserSettingsSchema` | `userSettings` | `createdAt`, `updatedAt` |
| `insertNotificationPreferencesSchema` | `notificationPreferences` | `createdAt`, `updatedAt` |
| `insertPlayerSyncStateSchema` | `playerSyncState` | `updatedAt` |
| `insertBattleHistorySchema` | `battleHistory` | `id`, `createdAt` |
| `insertCoachMessageSchema` | `coachMessages` | `id`, `createdAt` |
| `insertPushAnalysisSchema` | `pushAnalyses` | `id`, `createdAt` |
| `insertTrainingPlanSchema` | `trainingPlans` | `id`, `createdAt`, `updatedAt` |
| `insertTrainingDrillSchema` | `trainingDrills` | `id`, `createdAt`, `updatedAt` |
| `insertMetaDeckCacheSchema` | `metaDecksCache` | `id` |
| `insertDeckSuggestionsUsageSchema` | `deckSuggestionsUsage` | `id`, `createdAt` |

### Request Validation Schemas (custom Zod)

| Schema | Purpose | Key Validations |
|--------|---------|-----------------|
| `profileCreateInputSchema` | POST /api/profile | `clashTag`: regex `#?[A-Za-z0-9]+`, max 16 chars, auto-normalize |
| `profileUpdateInputSchema` | PATCH /api/profile | Partial of create, requires >= 1 field |
| `settingsUpdateInputSchema` | PATCH /api/settings | theme: `light\|dark\|system`, landingPage: `dashboard\|community\|goals\|coach` |
| `notificationPreferencesUpdateInputSchema` | PATCH /api/notification-preferences | >= 1 boolean required |
| `goalCreateInputSchema` | POST /api/goals | type: `trophies\|streak\|winrate\|custom`, targetValue: `int >= 0` |
| `goalUpdateInputSchema` | PATCH /api/goals/:id | Partial of create, >= 1 field |
| `favoriteCreateInputSchema` | POST /api/favorites | playerTag: normalized tag, name: 1-80 chars |
| `coachChatInputSchema` | POST /api/coach/chat | messages: `[{role, content}]+`, role: `user\|assistant\|system` |
| `counterDeckRequestSchema` | POST /api/decks/counter | targetCardKey: 1-80 chars, deckStyle: `balanced\|cycle\|heavy` |
| `deckOptimizerRequestSchema` | POST /api/decks/optimizer | currentDeck: exactly 8 cards, goal: `cycle\|counter-card\|consistency` |
| `trainingDrillUpdateInputSchema` | PATCH /api/training/drills/:id | status: `pending\|in_progress\|completed\|skipped` |
| `trainingPlanUpdateInputSchema` | PATCH /api/training/plans/:id | status: `active\|archived\|completed` |
| `playerSyncRequestSchema` | POST /api/player/sync | Empty strict object |

---

## Enums & Constants

The schema does not use PostgreSQL `ENUM` types. All enum-like values are stored as `varchar` and enforced at the application/Zod level:

### Plan Values (`subscriptions.plan`)
- `free`
- `pro`

### Subscription Status (`subscriptions.status`)
- `inactive`
- `active`
- `canceled`
- `past_due`

### Goal Types (`goals.type`)
- `trophies`
- `streak`
- `winrate`
- `custom`

### Coach Message Roles (`coach_messages.role`)
- `user`
- `assistant`
- `system`

### Profile Roles (`profiles.role`)
- `user`
- `admin`

### Theme Values (`user_settings.theme`)
- `light`
- `dark`
- `system`

### Landing Page Values (`user_settings.default_landing_page`)
- `dashboard`
- `community`
- `goals`
- `coach`

### Training Plan Status (`training_plans.status`)
- `active`
- `archived`
- `completed`

### Training Plan Source (`training_plans.source`)
- `manual`
- `ai` (generated by push analysis)

### Training Drill Status (`training_drills.status`)
- `pending`
- `in_progress`
- `completed`
- `skipped`

### Deck Suggestion Types (`deck_suggestions_usage.suggestion_type`)
- `counter`
- `optimizer`

### Deck Styles (`counterDeckRequestSchema`)
- `balanced`
- `cycle`
- `heavy`

### Optimizer Goals (`deckOptimizerRequestSchema`)
- `cycle`
- `counter-card`
- `consistency`

### Notification Types (`notifications.type`)
- `training`
- `billing`
- `system`

### Business Constants (from code)
- `FREE_BATTLE_LIMIT`: 10 battles
- `PRO_HISTORY_MAX_DAYS`: 60 days
- `FREE_DAILY_LIMIT`: 5 coach messages/day
- `FREE_DECK_SUGGESTION_DAILY_LIMIT`: 2 per type/day

---

## Drizzle Relations (ORM-level)

The schema defines explicit Drizzle `relations()` for query builder joins. These are ORM-level only and do not generate database constraints beyond the FK definitions above.

```
usersRelations:
  - one(profiles)
  - one(subscriptions)
  - many(goals)
  - many(favoritePlayers)
  - many(notifications)
  - one(userSettings)
  - one(notificationPreferences)
  - one(playerSyncState)
  - many(battleHistory)
  - many(coachMessages)
  - many(pushAnalyses)
  - many(trainingPlans)

trainingPlansRelations:
  - one(users)
  - one(pushAnalyses)  -- optional link
  - many(trainingDrills)

trainingDrillsRelations:
  - one(trainingPlans)
```

---

*Document generated by @data-engineer (Dara) for Brownfield Discovery Phase 2.*
